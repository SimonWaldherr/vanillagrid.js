!function(t){const e="undefined"!=typeof window?window:t,a=e.VanillaGrid;if(!a)return void console.warn("[VG Pivot d3] VanillaGrid not found. Load this plugin after vanillagrid.js");if(a.prototype.__vgPivotD3Patched)return;a.prototype.__vgPivotD3Patched=!0,a.prototype._vgD3Promise=null,a.prototype._ensureD3=function(t){if(e.d3)return Promise.resolve(e.d3);if(this._vgD3Promise)return this._vgD3Promise;const a=t||this.opts?.d3Url||"https://cdn.jsdelivr.net/npm/d3@7";return this._vgD3Promise=new Promise((t,r)=>{const n=document.createElement("script");n.src=a,n.async=!0,n.onload=()=>t(e.d3),n.onerror=t=>r(new Error("Failed to load d3.js: "+a)),document.head.appendChild(n)}),this._vgD3Promise},a.prototype._populateChartValueSelect=function(){const t=this.root.querySelector(".vg-chart-value");if(!t||!this.state?.pivotData?.columns)return;const e=this.state.pivotData.columns.filter(t=>"number"===t.type),a=Array.from(new Set(e.map(t=>String(t.key).split("_")[0])));if(0===a.length)return void(t.innerHTML='<option value="">(none)</option>');const r=this.opts?.pivotConfig?.chart?.value;t.innerHTML=a.map(t=>{return`<option value="${e=t,i(e).replace(/"/g,"&quot;")}"${r===t?" selected":""}>${i(t)}</option>`;var e}).join("")};const r=a.prototype._renderPivotToolbar;a.prototype._renderPivotToolbar=function(){r.call(this);const t=this.root.querySelector(".vg-toolbar");if(!t)return;if(t.querySelector(".vg-pivot-chart-panel"))return;const e=document.createElement("div");e.className="vg-pivot-chart-panel",e.innerHTML='\n      <div class="vg-chart-header">\n        <div class="vg-chart-title">ðŸ“ˆ <strong>Data Visualization</strong></div>\n        <button class="vg-chart-collapse-btn" aria-expanded="true">â–¼</button>\n      </div>\n      <div class="vg-chart-body">\n        <div class="vg-chart-controls">\n          <div class="vg-chart-control"><label>Chart Type</label><select class="vg-chart-type"><option value="grouped">Grouped Bars</option><option value="stacked">Stacked Bars</option><option value="line">Line</option><option value="pie">Pie</option></select></div>\n          <div class="vg-chart-control"><label>Measure</label><select class="vg-chart-value"></select></div>\n          <div class="vg-chart-control vg-chart-flags"><label><input type="checkbox" class="vg-chart-normalize" /> Normalize (%)</label><label><input type="checkbox" class="vg-chart-legend" checked /> Show legend</label><label><input type="checkbox" class="vg-chart-autorender" /> Auto-render</label></div>\n          <div class="vg-chart-actions"><button class="vg-btn vg-chart-render">ðŸ”„ Render</button><button class="vg-btn vg-chart-export">ðŸ“· Export PNG</button></div>\n        </div>\n        <div class="vg-chart-container"><div class="vg-chart-wrapper"><div id="vg-pivot-chart" role="img"></div></div><div class="vg-chart-empty">Configure pivot and click Render</div></div>\n      </div>\n    ',t.appendChild(e);try{const t=this.opts?.pivotConfig?.chart||{},a=e.querySelector(".vg-chart-type");a&&t.type&&(a.value=t.type);const r=e.querySelector(".vg-chart-normalize");r&&"boolean"==typeof t.normalize&&(r.checked=t.normalize);const n=e.querySelector(".vg-chart-legend");n&&"boolean"==typeof t.showLegend&&(n.checked=t.showLegend);const o=e.querySelector(".vg-chart-autorender");o&&"boolean"==typeof t.autorender&&(o.checked=t.autorender)}catch(t){}this._populateChartValueSelect(),e.querySelector(".vg-chart-collapse-btn")?.addEventListener("click",t=>{e.classList.toggle("collapsed"),t.currentTarget.setAttribute("aria-expanded",String(!e.classList.contains("collapsed")))}),e.querySelector(".vg-chart-render")?.addEventListener("click",async()=>{await this._renderPivotChart()}),e.querySelector(".vg-chart-export")?.addEventListener("click",()=>{this._exportChartAsPng()});const a=this.opts?.pivotConfig?.chart;a?.autorender&&this._renderPivotChart().catch(()=>{})};const n=a.prototype.updatePivotConfig;function o(t,e,a){return a?(t?t+": ":"")+Math.round(1e3*e)/10+"%":(t?t+": ":"")+l(e)}function l(t){try{return(new Intl.NumberFormat).format(t)}catch{return String(t)}}function i(t){return String(t??"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]))}a.prototype.updatePivotConfig=function(t){n.call(this,t);try{this._populateChartValueSelect()}catch{}const e=this.opts?.pivotConfig?.chart;e?.autorender&&this._renderPivotChart().catch(()=>{})},a.prototype._exportChartAsPng=function(){const t=this.root.querySelector("#vg-pivot-chart svg");if(!t)return;const e=(new XMLSerializer).serializeToString(t),a=document.createElement("canvas"),r=a.getContext("2d"),n=new Image,o=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),l=URL.createObjectURL(o);n.onload=()=>{a.width=2*n.width,a.height=2*n.height,r.scale(2,2),r.fillStyle="#fff",r.fillRect(0,0,n.width,n.height),r.drawImage(n,0,0);const t=a.toDataURL("image/png"),e=document.createElement("a");e.href=t,e.download="pivot-chart.png",e.click(),URL.revokeObjectURL(l)},n.src=l},a.prototype._renderPivotChart=async function(){const t=this.root.querySelector("#vg-pivot-chart"),e=this.root.querySelector(".vg-chart-empty"),a=this.root.querySelector(".vg-chart-wrapper");if(!t)return;const r=this.state?.pivotData;if(!r||!r.rows||!r.columns||0===r.rows.length)return t.innerHTML="",e&&(e.style.display="flex"),void(a&&(a.style.display="none"));let n;try{n=await this._ensureD3(this.opts?.d3Url)}catch(e){return void(t.innerHTML='<div class="vg-chart-error">Failed to load d3</div>')}const o=this.root.querySelector(".vg-pivot-chart-panel"),l=o?.querySelector(".vg-chart-type"),i=o?.querySelector(".vg-chart-value"),s=!!o?.querySelector(".vg-chart-normalize")?.checked,c=!!o?.querySelector(".vg-chart-legend")?.checked,d=l?.value||this.opts?.pivotConfig?.chart?.type||"grouped",h=i?.value||this.opts?.pivotConfig?.chart?.value||r.columns.find(t=>"number"===t.type)?.key.split("_")[0]||null;if(!h)return void(t.innerHTML='<div class="vg-chart-error">No numeric measure</div>');e&&(e.style.display="none"),a&&(a.style.display="block");let p=r.columns.filter(t=>"number"===t.type).filter(t=>String(t.key).startsWith(h)).map(t=>t.key.includes("_")?t.key.slice(h.length+1):"").filter((t,e,a)=>a.indexOf(t)===e);0===p.length&&(p=[""]);const g=this.opts?.pivotConfig?.rows||[],v=t=>g.map(e=>t[e]).filter(Boolean).join(" / ")||"(total)",u=r.rows,m=u.map(v),f=u.map(t=>{const e=p.map(e=>{return+t[(a=e,a?`${h}_${a}`:h)]||0;var a}),a=e.reduce((t,e)=>t+e,0)||1;return{label:v(t),values:p.map((t,r)=>s?e[r]/a:e[r])}});t.innerHTML="","pie"===d&&this._renderPieChart?this._renderPieChart(n,t,f,p,h,c):"line"===d&&this._renderLineChart?this._renderLineChart(n,t,f,m,p,h,s,c):this._renderBarChart?this._renderBarChart(n,t,f,m,p,h,d,s,c):t.innerHTML='<div class="vg-chart-error">No renderer available</div>'},a.prototype._renderBarChart=function(t,e,a,r,n,l,i,s,c){const d=c?40:20,h=24,p=Math.min(100,40+4*r.length),g=70,v=Math.max(400,e.clientWidth||640),u=Math.max(300,e.clientHeight||360),m=v-g-h,f=u-d-p,y=t.select(e).append("svg").attr("width",v).attr("height",u).attr("role","img"),b=y.append("g").attr("transform",`translate(${g},${d})`),x=t.scaleBand().domain(r).range([0,m]).paddingInner(.2),w=t.scaleOrdinal().domain(n).range(t.schemeTableau10);let k;if("stacked"===i){const e=s?1:t.max(a,t=>t.values.reduce((t,e)=>t+e,0))||0;k=t.scaleLinear().domain([0,e]).nice().range([f,0]);const i=n.map((t,e)=>String(e)),c=a.map(t=>{const e={};return t.values.forEach((t,a)=>e[String(a)]=t),e}),d=t.stack().keys(i)(c);b.selectAll(".layer").data(d).join("g").attr("fill",(t,e)=>w(n[e])).selectAll("rect").data(t=>t.map((t,e)=>({seg:t,idx:e}))).join("rect").attr("x",t=>x(r[t.idx])).attr("y",t=>k(t.seg[1])).attr("height",t=>Math.max(0,k(t.seg[0])-k(t.seg[1]))).attr("width",x.bandwidth()).attr("rx",2).append("title").text(t=>o(n[+t.seg.key]||l,t.seg[1]-t.seg[0],s))}else{const e=t.scaleBand().domain(n).range([0,x.bandwidth()]).padding(.08),r=t.max(a,e=>t.max(e.values))||0;k=t.scaleLinear().domain([0,s?1:r]).nice().range([f,0]);b.selectAll(".cat").data(a).join("g").attr("transform",t=>`translate(${x(t.label)},0)`).selectAll("rect").data(t=>t.values.map((t,e)=>({series:n[e],value:t}))).join("rect").attr("x",t=>e(t.series)).attr("y",t=>k(t.value)).attr("width",e.bandwidth()).attr("height",t=>f-k(t.value)).attr("fill",t=>w(t.series)).attr("rx",2).append("title").text(t=>o(t.series||l,t.value,s))}b.append("g").attr("transform",`translate(0,${f})`).call(t.axisBottom(x)).selectAll("text").attr("transform",r.length>6?"rotate(-35)":null).style("text-anchor",r.length>6?"end":"middle"),b.append("g").call(t.axisLeft(k).ticks(6)),c&&(n.length>1||""!==n[0])&&this._renderLegend(t,y,n,l,w,g,12,m)},a.prototype._renderLineChart=function(t,e,a,r,n,l,i,s){const c=s?40:20,d=24,h=Math.min(100,40+4*r.length),p=70,g=Math.max(400,e.clientWidth||640),v=Math.max(300,e.clientHeight||360),u=g-p-d,m=v-c-h,f=t.select(e).append("svg").attr("width",g).attr("height",v).attr("role","img"),y=f.append("g").attr("transform",`translate(${p},${c})`),b=t.scalePoint().domain(r).range([0,u]).padding(.5),x=t.scaleOrdinal().domain(n).range(t.schemeTableau10),w=t.max(a,e=>t.max(e.values))||0,k=t.scaleLinear().domain([0,i?1:w]).nice().range([m,0]);y.append("g").call(t.axisLeft(k).tickSize(-u).tickFormat("").ticks(6)).selectAll("line").style("stroke","#e5e7eb").style("stroke-dasharray","3,3"),n.forEach((e,n)=>{const s=a.map((t,e)=>({x:r[e],y:t.values[n]})),c=t.line().x(t=>b(t.x)).y(t=>k(t.y)).curve(t.curveMonotoneX);y.append("path").datum(s).attr("fill","none").attr("stroke",x(e)).attr("stroke-width",2.5).attr("d",c),y.selectAll(`.vg-point-${n}`).data(s).join("circle").attr("cx",t=>b(t.x)).attr("cy",t=>k(t.y)).attr("r",5).attr("fill",x(e)).attr("stroke","#fff").attr("stroke-width",2).append("title").text(t=>o(e||l,t.y,i))}),y.append("g").attr("transform",`translate(0,${m})`).call(t.axisBottom(b)).selectAll("text").attr("transform",r.length>6?"rotate(-35)":null).style("text-anchor",r.length>6?"end":"middle"),y.append("g").call(t.axisLeft(k).ticks(6)),s&&(n.length>1||""!==n[0])&&this._renderLegend(t,f,n,l,x,p,12,u)},a.prototype._renderPieChart=function(t,e,a,r,n,o){const i=Math.max(400,e.clientWidth||500),s=Math.max(300,e.clientHeight||360),c=Math.min(i,s)/2-40,d=t.select(e).append("svg").attr("width",i).attr("height",s).attr("role","img"),h=d.append("g").attr("transform",`translate(${i/2},${s/2})`),p=a.map(t=>({label:t.label,value:t.values[0]||0})).filter(t=>t.value>0),g=t.scaleOrdinal().domain(p.map(t=>t.label)).range(t.schemeTableau10),v=t.pie().value(t=>t.value).sort(null),u=t.arc().innerRadius(.4*c).outerRadius(c);if(h.selectAll(".arc").data(v(p)).join("g").attr("class","arc").append("path").attr("d",u).attr("fill",t=>g(t.data.label)).attr("stroke","#fff").attr("stroke-width",2).append("title").text(t=>{const e=p.reduce((t,e)=>t+e.value,0),a=(t.data.value/e*100).toFixed(1);return`${t.data.label}: ${l(t.data.value)} (${a}%)`}),o){const t=d.append("g").attr("transform",`translate(${i-120},20)`);p.slice(0,8).forEach((e,a)=>{const r=t.append("g").attr("transform",`translate(0,${20*a})`);r.append("rect").attr("width",12).attr("height",12).attr("rx",2).attr("fill",g(e.label)),r.append("text").attr("x",18).attr("y",10).attr("font-size",11).attr("fill","#374151").text(e.label.length>12?e.label.slice(0,12)+"â€¦":e.label)})}},a.prototype._renderLegend=function(t,e,a,r,n,o,l,i){const s=e.append("g").attr("transform",`translate(${o},${l})`);let c=0;const d=s.selectAll(".lg").data(a).join("g").attr("transform",(t,e)=>{const r=c;return c+=Math.min(120,i/a.length),`translate(${r},0)`});d.append("rect").attr("width",12).attr("height",12).attr("rx",2).attr("fill",t=>n(t)),d.append("text").attr("x",18).attr("y",10).attr("font-size",11).attr("fill","#374151").text(t=>(t||r).length>15?(t||r).slice(0,15)+"â€¦":t||r)}}("undefined"!=typeof window?window:globalThis);