!function(t){const e="undefined"!=typeof window?window:t,a=e.VanillaGrid;if(!a)return void console.warn("[VG Pivot d3] VanillaGrid not found. Load this plugin after vanillagrid.js");if(a.prototype.__vgPivotD3Patched)return;a.prototype.__vgPivotD3Patched=!0,a.prototype._vgD3Promise=null,a.prototype._ensureD3=function(t){if(e.d3)return Promise.resolve(e.d3);if(this._vgD3Promise)return this._vgD3Promise;const a=t||this.opts?.d3Url||"https://cdn.jsdelivr.net/npm/d3@7";return this._vgD3Promise=new Promise((t,r)=>{const n=document.createElement("script");n.src=a,n.async=!0,n.onload=()=>t(e.d3),n.onerror=t=>r(new Error("Failed to load d3.js: "+a)),document.head.appendChild(n)}),this._vgD3Promise},a.prototype._populateChartValueSelect=function(){const t=this.root.querySelector(".vg-chart-value");if(!t||!this.state?.pivotData?.columns)return;const e=this.state.pivotData.columns.filter(t=>"number"===t.type),a=Array.from(new Set(e.map(t=>String(t.key).split("_")[0])));if(0===a.length)return void(t.innerHTML='<option value="">(keine)</option>');const r=this.opts?.pivotConfig?.chart?.value;t.innerHTML=a.map(t=>{return`<option value="${e=t,o(e).replace(/"/g,"&quot;")}"${r===t?" selected":""}>${o(t)}</option>`;var e}).join("")};const r=a.prototype._renderPivotToolbar;a.prototype._renderPivotToolbar=function(){r.call(this);const t=this.root.querySelector(".vg-toolbar");if(!t)return;if(t.querySelector("#vg-pivot-chart"))return;const e=document.createElement("div");e.className="vg-pivot-chart-panel",e.innerHTML='\n      <div class="vg-pivot-chart-controls">\n        <label class="vg-pivot-chart-label">Diagramm</label>\n        <select class="vg-chart-type" aria-label="Diagrammtyp">\n          <option value="grouped">SÃ¤ulen (gruppiert)</option>\n          <option value="stacked">SÃ¤ulen (gestapelt)</option>\n        </select>\n        <label class="vg-pivot-chart-label">Wert</label>\n        <select class="vg-chart-value" aria-label="Kennzahl"></select>\n        <label class="vg-pivot-chart-check">\n          <input type="checkbox" class="vg-chart-normalize" /> % normalisieren\n        </label>\n        <button class="vg-btn vg-chart-render" type="button">ðŸ“ˆ Render</button>\n      </div>\n      <div id="vg-pivot-chart" role="img" aria-label="Pivot Diagramm" class="vg-pivot-chart"></div>\n    ',t.appendChild(e);try{const e=this.opts?.pivotConfig?.chart||{},a=t.querySelector(".vg-chart-type"),r=t.querySelector(".vg-chart-normalize");a&&e.type&&(a.value=e.type),r&&"boolean"==typeof e.normalize&&(r.checked=e.normalize)}catch{}this._populateChartValueSelect(),t.querySelector(".vg-chart-render")?.addEventListener("click",async()=>{await this._renderPivotChart()});const a=this.opts?.pivotConfig?.chart;a?.autorender&&this._renderPivotChart().catch(()=>{})};const n=a.prototype.updatePivotConfig;function o(t){return String(t??"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]))}a.prototype.updatePivotConfig=function(t){n.call(this,t);try{this._populateChartValueSelect()}catch{}const e=this.opts?.pivotConfig?.chart;e?.autorender&&this._renderPivotChart().catch(()=>{})},a.prototype._renderPivotChart=async function(){const t=this.root.querySelector("#vg-pivot-chart");if(!t)return;const e=this.state?.pivotData;if(!e||!e.rows||!e.columns)return void(t.innerHTML='<div class="vg-pivot-chart-msg">Keine Pivot-Daten vorhanden.</div>');let a;try{a=await this._ensureD3(this.opts?.d3Url)}catch(e){return void(t.innerHTML='<div class="vg-pivot-chart-msg vg-error-msg">d3.js konnte nicht geladen werden.</div>')}const r=this.root.querySelector(".vg-toolbar"),n=r?.querySelector(".vg-chart-type"),o=r?.querySelector(".vg-chart-value"),i=!!r?.querySelector(".vg-chart-normalize")?.checked,l=n?.value||this.opts?.pivotConfig?.chart?.type||"grouped",s=o?.value||this.opts?.pivotConfig?.chart?.value||e.columns.find(t=>"number"===t.type)?.key.split("_")[0]||null;if(!s)return void(t.innerHTML='<div class="vg-pivot-chart-msg">Keine numerische Kennzahl gefunden.</div>');let c=e.columns.filter(t=>"number"===t.type).filter(t=>String(t.key).startsWith(s)).map(t=>t.key.includes("_")?t.key.slice(s.length+1):"").filter((t,e,a)=>a.indexOf(t)===e);0===c.length&&(c=[""]);const p=this.opts?.pivotConfig?.rows||[],d=t=>p.map(e=>t[e]).filter(Boolean).join(" / ")||"(gesamt)",h=e.rows,v=h.map(d),u=h.map(t=>{const e=c.map(e=>{return+t[(a=e,a?`${s}_${a}`:s)]||0;var a}),a=e.reduce((t,e)=>t+e,0)||1;return{label:d(t),values:c.map((t,r)=>i?e[r]/a:e[r])}});t.innerHTML="";const g=28,m=16,f=Math.min(80,16+6*v.length),y=64,b=Math.max(320,t.clientWidth||640),w=Math.max(240,t.clientHeight||320),_=b-y-m,S=w-g-f,P=a.select(t).append("svg").attr("width",b).attr("height",w).attr("role","img").attr("aria-label","Pivot Diagramm"),x=P.append("g").attr("transform",`translate(${y},${g})`),k=a.scaleBand().domain(v).range([0,_]).paddingInner(.2),C=a.scaleOrdinal().domain(c).range(a.schemeTableau10);let D,q;if("stacked"===l){const t=i?1:a.max(u,t=>t.values.reduce((t,e)=>t+e,0))||0;D=a.scaleLinear().domain([0,t]).nice().range([S,0]),q=i?a.format(".0%"):a.format("~s");const e=c.map((t,e)=>String(e)),r=u.map(t=>{const e={};return t.values.forEach((t,a)=>e[String(a)]=t),e.__label=t.label,e}),n=a.stack().keys(e)(r);x.selectAll(".layer").data(n).join("g").attr("class","layer").attr("fill",(t,e)=>C(c[e])).selectAll("rect").data(t=>t.map((t,e)=>({seg:t,idx:e}))).join("rect").attr("x",t=>k(v[t.idx])).attr("y",t=>D(t.seg[1])).attr("height",t=>Math.max(0,D(t.seg[0])-D(t.seg[1]))).attr("width",k.bandwidth()).append("title").text(t=>j(c[+t.seg.key]||s,t.seg[1]-t.seg[0],i))}else{const t=a.scaleBand().domain(c).range([0,k.bandwidth()]).padding(.08),e=a.max(u,t=>a.max(t.values))||0;D=a.scaleLinear().domain([0,i?1:e]).nice().range([S,0]),q=i?a.format(".0%"):a.format("~s");x.selectAll(".cat").data(u).join("g").attr("class","cat").attr("transform",t=>`translate(${k(t.label)},0)`).selectAll("rect").data(t=>t.values.map((t,e)=>({series:c[e],value:t}))).join("rect").attr("x",e=>t(e.series)).attr("y",t=>D(t.value)).attr("width",t.bandwidth()).attr("height",t=>S-D(t.value)).attr("fill",t=>C(t.series)).append("title").text(t=>j(t.series||s,t.value,i))}const L=a.axisBottom(k).tickSizeOuter(0),M=a.axisLeft(D).tickFormat(q).ticks(6);if(x.append("g").attr("transform",`translate(0,${S})`).call(L).selectAll("text").attr("dy","0.9em").attr("transform",v.length>6?"rotate(20)":null).style("text-anchor",v.length>6?"start":"middle"),x.append("g").call(M),c.length>1||""!==c[0]){const t=P.append("g").attr("transform",`translate(${y},12)`).selectAll(".lg").data(c).join("g").attr("class","lg").attr("transform",(t,e)=>`translate(${120*e},0)`);t.append("rect").attr("width",12).attr("height",12).attr("rx",2).attr("ry",2).attr("fill",t=>C(t)),t.append("text").attr("x",18).attr("y",10).attr("font-size",12).text(t=>t||s)}function j(t,e,a){if(a)return(t?t+": ":"")+Math.round(1e3*e)/10+"%";try{return(t?t+": ":"")+(new Intl.NumberFormat).format(e)}catch{return(t?t+": ":"")+String(e)}}}}("undefined"!=typeof window?window:globalThis);