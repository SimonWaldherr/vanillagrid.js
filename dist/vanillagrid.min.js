/*!
 * VanillaGrid — a tiny table library
 * Features: sort, filter (text/RegExp), pagination, group-by (sum/min/max), rich cell types
 * No dependencies. MIT License.
 */
!function(t){class e{constructor(t,e){if(this.container="string"==typeof t?document.querySelector(t):t,!this.container)throw new Error("VanillaGrid: container not found");const s={data:[],columns:[],pageSize:10,pageSizes:[10,25,50,100],sortable:!0,filterable:!0,pagination:!0,groupable:!0,groupBy:null,regexFilter:!1,className:"",emptyMessage:"No rows to display.",i18n:{tableLabel:"Data table",filterPlaceholder:"Filter...",regexLabel:"RegExp",invalidRegex:"Invalid RegExp",noGroup:"No group",groupByPrefix:"Group by",perPageSuffix:" / page",pager:{pageInfo:(t,e)=>`Page ${t} of ${e}`,prev:"Previous page",next:"Next page",first:"First page",last:"Last page",totalRows:t=>`${t} row(s)`,totalGroups:t=>`${t} group(s)`},group:{count:"Count",min:"min",max:"max"},aria:{toggleGroup:"Toggle group",expandRow:"Expand",collapseRow:"Collapse"},export:{button:"Export",csv:"CSV",markdown:"Markdown",format:"Format"}},tree:{enabled:!1,childrenKey:"children",indent:16,lazy:!1,initiallyExpanded:!1,hasChildrenKey:"hasChildren"},loadChildren:null,serverPagination:!1,serverSorting:!1,serverFiltering:!1,loadPage:null,exporting:{enabled:!0,formats:["csv","md"],scope:"page",filename:"vanillagrid"},selectable:!1,onSelectionChange:null,columnsMenu:!0};this.opts=Object.assign({},s,e||{}),e&&e.tree&&(this.opts.tree=Object.assign({},s.tree,e.tree)),this.columns=this.opts.columns,this.data=Array.isArray(this.opts.data)?this.opts.data.slice():[],this._idCounter=0,this._assignIdsDeep(this.data),this.rowById=new Map,this._indexRowsDeep(this.data),this.state={sortKey:null,sortDir:"asc",filter:"",regexMode:!!this.opts.regexFilter,page:1,pageSize:this.opts.pageSize,groupBy:this.opts.groupBy,regexError:"",collapsed:new Set,expanded:new Set,loadingChildren:new Set,serverTotalRows:null,selected:new Set,hiddenCols:new Set},this.root=document.createElement("div"),this.root.className=`vg-container ${this.opts.className}`.trim(),this.container.innerHTML="",this.container.appendChild(this.root),this._render()}setData(t){this.data=Array.isArray(t)?t.slice():[],this._idCounter=0,this._assignIdsDeep(this.data),this.rowById=new Map,this._indexRowsDeep(this.data),this.state.page=1,this._renderBody(),this._renderPager()}getData(){return this.data.slice()}setGroupBy(t){this.state.groupBy=t||null,this.state.page=1,this._renderBody(),this._renderPager()}setFilter(t,e={}){this.state.filter=t??"",null!=e.regexMode&&(this.state.regexMode=!!e.regexMode),this.state.page=1,this._renderToolbar(),this._shouldRemoteFetch("filter")?this._remoteLoad(1):(this._renderBody(),this._renderPager())}setSort(t,e="asc"){this.state.sortKey=t,this.state.sortDir="desc"===e?"desc":"asc",this._renderHeader(),this._shouldRemoteFetch("sort")?this._remoteLoad(1):this._renderBody()}setPageSize(t){this.state.pageSize=+t||10,this.state.page=1,this._renderPager(),this._shouldRemoteFetch("page")?this._remoteLoad(1):this._renderBody()}setMarkdown(t,e={}){const s=this._parseMarkdownTables(String(t||"")),r=s[Math.max(0,Math.min(e.tableIndex||0,s.length-1))];if(!r)return this.columns=[],void this.setData([]);const a=this._uniqueKeys(r.headers.map(t=>this._slugify(String(t||"col")))),i=a.map((t,e)=>({key:t,label:r.headers[e],type:"html",sortable:!0})),o=r.rows.map(t=>{const e={};return t.forEach((t,s)=>e[a[s]]=this._mdInlineToHtml(t)),e});this.columns=i,this._renderHeader(),this.setData(o)}async loadMarkdown(t,e){const s=await fetch(t,e),r=await s.text();this.setMarkdown(r)}downloadCSV(t){const e=(t||this.opts.exporting.filename||"vanillagrid")+".csv",{headers:s,rows:r}=this._exportMatrix(),a=this._toCSV([s,...r]);this._downloadBlob(a,e,"text/csv;charset=utf-8;")}downloadMarkdown(t){const e=(t||this.opts.exporting.filename||"vanillagrid")+".md",{headers:s,rows:r}=this._exportMatrix(),a=this._toMarkdown(s,r);this._downloadBlob(a,e,"text/markdown;charset=utf-8;")}_render(){this.root.innerHTML=`\n        <div class="vg-toolbar"></div>\n        <div class="vg-table-wrap">\n      <table class="vg-table" role="table" aria-label="${this._escAttr(this.opts.i18n.tableLabel)}">\n            <thead></thead>\n            <tbody></tbody>\n          </table>\n        </div>\n        <div class="vg-pager"></div>\n      `,this.toolbarEl=this.root.querySelector(".vg-toolbar"),this.theadEl=this.root.querySelector("thead"),this.tbodyEl=this.root.querySelector("tbody"),this.pagerEl=this.root.querySelector(".vg-pager"),this.tableEl=this.root.querySelector(".vg-table"),this._renderToolbar(),this._renderHeader(),this._bindTableEvents(),this._shouldRemoteFetch("init")?this._remoteLoad(1):(this._renderBody(),this._renderPager()),this._applyColumnVisibility()}_renderToolbar(){const t=this.opts.filterable,e=this.opts.groupable,s=this.opts.i18n,r=this.opts.pageSizes,a=[`<option value="">${this._esc(s.noGroup)}</option>`].concat(this.columns.map(t=>`<option value="${this._esc(t.key)}" ${this.state.groupBy===t.key?"selected":""}>${this._esc(s.groupByPrefix)} ${this._esc(t.label??t.key)}</option>`)),i=r.map(t=>`<option value="${t}" ${+this.state.pageSize===+t?"selected":""}>${t}${this._esc(s.perPageSuffix)}</option>`),o=this.opts.exporting&&this.opts.exporting.enabled?`<div class="vg-export">\n            <select class="vg-export-format" aria-label="${this._escAttr(s.export.format)}">\n              ${this.opts.exporting.formats.map(t=>"csv"===t?`<option value="csv">${this._esc(s.export.csv)}</option>`:`<option value="md">${this._esc(s.export.markdown)}</option>`).join("")}\n            </select>\n    <button class="vg-export-btn" type="button" aria-label="${this._escAttr(s.export.button)}" title="${this._escAttr(s.export.button)}">${this._esc(s.export.button)}</button>\n          </div>`:"",n=!1!==this.opts.columnsMenu?`<details class="vg-cols">\n             <summary class="vg-btn" aria-haspopup="true">Columns</summary>\n             <div class="vg-cols-list" role="menu">\n               ${this.columns.map(t=>{const e=this.state.hiddenCols.has(t.key);return`<label style="display:flex;gap:6px;align-items:center;padding:4px 2px;">\n                    <input type="checkbox" data-col-toggle value="${this._escAttr(t.key)}" ${e?"":"checked"} />\n                    <span>${this._esc(t.label??t.key)}</span>\n                  </label>`}).join("")}\n             </div>\n           </details>`:"";this.toolbarEl.innerHTML=`\n        <div class="vg-toolbar-row">\n          ${t?`\n          <div class="vg-filter">\n            <input type="text" class="vg-filter-input" placeholder="${this._escAttr(s.filterPlaceholder)}" value="${this._escAttr(this.state.filter)}" aria-label="${this._escAttr(s.filterPlaceholder)}" />\n            <label class="vg-regex">\n              <input type="checkbox" class="vg-filter-regex" ${this.state.regexMode?"checked":""} />\n              ${this._esc(s.regexLabel)}\n            </label>\n            ${this.state.regexError?`<span class="vg-error" title="${this._escAttr(this.state.regexError)}">${this._esc(s.invalidRegex)}</span>`:""}\n          </div>`:""}\n          ${e?`\n          <div class="vg-groupby">\n            <select class="vg-group-select" aria-label="${this._escAttr(s.groupByPrefix)}">\n              ${a.join("")}\n            </select>\n          </div>`:""}\n          <div class="vg-pagesize">\n            <select class="vg-size-select" aria-label="Page size">\n              ${i.join("")}\n            </select>\n          </div>\n          ${o}\n          ${n}\n        </div>\n      `;const l=this.toolbarEl.querySelector(".vg-filter-input"),h=this.toolbarEl.querySelector(".vg-filter-regex"),c=this.toolbarEl.querySelector(".vg-group-select"),d=this.toolbarEl.querySelector(".vg-size-select"),p=this.toolbarEl.querySelector(".vg-export-btn"),g=this.toolbarEl.querySelector(".vg-export-format"),u=this.toolbarEl.querySelectorAll("input[data-col-toggle]");l&&(l.oninput=()=>{this.setFilter(l.value,{regexMode:this.state.regexMode})}),h&&(h.onchange=()=>{this.setFilter(this.state.filter,{regexMode:h.checked})}),c&&(c.onchange=()=>{this.state.groupBy=c.value||null,this.state.page=1,this.state.collapsed.clear(),this._renderBody(),this._renderPager()}),d&&(d.onchange=()=>{this.setPageSize(+d.value)}),p&&g&&(p.onclick=()=>{"csv"===g.value?this.downloadCSV():this.downloadMarkdown()}),u&&u.length&&u.forEach(t=>{t.onchange=()=>{const e=t.value;t.checked?this.state.hiddenCols.delete(e):this.state.hiddenCols.add(e),this._applyColumnVisibility()}})}_renderHeader(){const{sortKey:t,sortDir:e}=this.state,s=document.createElement("tr");if(this.opts.selectable){const t=document.createElement("th");t.className="vg-th";const e=document.createElement("input");e.type="checkbox",e.className="vg-select-all";const r=this._currentPageRowIds(),a=r.filter(t=>this.state.selected.has(t));e.checked=r.length>0&&a.length===r.length,e.indeterminate=a.length>0&&a.length<r.length,e.onchange=()=>{const t=this._currentPageRowIds();e.checked?t.forEach(t=>this.state.selected.add(t)):t.forEach(t=>this.state.selected.delete(t)),this._renderBody(),this._renderHeader(),this._emitSelection()},t.appendChild(e),s.appendChild(t)}this.columns.forEach((r,a)=>{const i=document.createElement("th");i.setAttribute("role","columnheader"),i.tabIndex=0,i.dataset.key=r.key,i.className="vg-th",this.opts.sortable&&!1!==r.sortable&&(i.classList.add("vg-sortable"),t===r.key&&i.classList.add("asc"===e?"vg-asc":"vg-desc"));let o=this._esc(r.label??r.key);this.opts.tree.enabled&&0===a&&(o=`<span class="vg-tree-th-pad"></span>${o}`),i.innerHTML=`<span class="vg-th-text">${o}</span>`,this.opts.sortable&&!1!==r.sortable&&i.setAttribute("aria-sort",t===r.key?"asc"===e?"ascending":"descending":"none"),s.appendChild(i)}),this.theadEl.innerHTML="",this.theadEl.appendChild(s),this.theadEl.querySelectorAll(".vg-th.vg-sortable").forEach(t=>{t.onclick=()=>{const e=t.dataset.key;this.state.sortKey===e?this.state.sortDir="asc"===this.state.sortDir?"desc":"asc":(this.state.sortKey=e,this.state.sortDir="asc"),this._renderHeader(),this._shouldRemoteFetch("sort")?this._remoteLoad(1):this._renderBody()},t.onkeydown=e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.click())}})}_bindTableEvents(){this.tableEl.addEventListener("click",t=>{const e=t.target.closest(".vg-btn");if(e){const t=e.dataset.rowid,s=e.dataset.colkey,r=this.rowById.get(Number(t)),a=this.columns.find(t=>t.key===s);r&&a&&a.button&&"function"==typeof a.button.onClick&&a.button.onClick(r,e)}const s=t.target.closest(".vg-group-header");if(s){const t=s.dataset.groupValue;this.state.collapsed.has(t)?this.state.collapsed.delete(t):this.state.collapsed.add(t);const e=this.tbodyEl.querySelectorAll(`tr[data-group="${CSS.escape(t)}"]`),r=this.state.collapsed.has(t);e.forEach(t=>t.style.display=r?"none":""),s.classList.toggle("is-collapsed",r),s.setAttribute("aria-expanded",r?"false":"true")}const r=t.target.closest(".vg-tree-toggle");if(r){const t=Number(r.dataset.rowid),e=this.rowById.get(t);if(!e)return;if(this.state.expanded.has(t))this.state.expanded.delete(t),this._renderBody();else{this.opts.tree.enabled&&this.opts.tree.lazy&&!this._rowHasChildren(e)&&this._rowPotentialChildren(e)&&"function"==typeof this.opts.loadChildren?(this.state.loadingChildren.add(t),this._renderBody(),Promise.resolve().then(()=>this.opts.loadChildren(e)).then(t=>{const s=this.opts.tree.childrenKey;e[s]=Array.isArray(t)?t:[],this._assignIdsDeep(e[s]),this._indexRowsDeep(e[s])}).finally(()=>{this.state.loadingChildren.delete(t),this.state.expanded.add(t),this._renderBody()})):(this.state.expanded.add(t),this._renderBody())}}})}_renderBody(){const t=this._process();if(this.tbodyEl.innerHTML="",this.opts.tree.enabled){const e=t.pageFlatRows||[];if(0===e.length){const t=document.createElement("tr"),e=document.createElement("td");return e.colSpan=this._colCount(),e.className="vg-empty",e.textContent=this.opts.emptyMessage,t.appendChild(e),void this.tbodyEl.appendChild(t)}e.forEach(t=>{this.tbodyEl.appendChild(this._renderRow(t.row,t.depth,t))})}else if(t.hasGroups){const e=t.pageGroups;if(0===e.length){const t=document.createElement("tr"),e=document.createElement("td");return e.colSpan=this._colCount(),e.className="vg-empty",e.textContent=this.opts.emptyMessage,t.appendChild(e),void this.tbodyEl.appendChild(t)}e.forEach(t=>{const e=document.createElement("tr");e.className="vg-group";const s=document.createElement("td");s.colSpan=this._colCount();const r=this.state.collapsed.has(t.value);s.innerHTML=`\n            <button class="vg-group-header ${r?"is-collapsed":""}" data-group-value="${this._escAttr(t.value)}" title="${this._escAttr(this.opts.i18n.aria.toggleGroup)}" aria-expanded="${r?"false":"true"}">\n              <span class="vg-caret" aria-hidden="true"></span>\n              <span class="vg-group-title">${this._esc(this._headerLabelForGroup(t))}</span>\n            </button>\n            ${this._renderAggSummary(t)}\n          `,e.appendChild(s),this.tbodyEl.appendChild(e),t.rows.forEach(e=>{const s=this._renderRow(e);s.dataset.group=t.value,r&&(s.style.display="none"),this.tbodyEl.appendChild(s)})})}else{const e=t.pageRows;if(0===e.length){const t=document.createElement("tr"),e=document.createElement("td");return e.colSpan=this._colCount(),e.className="vg-empty",e.textContent=this.opts.emptyMessage,t.appendChild(e),void this.tbodyEl.appendChild(t)}e.forEach(t=>{this.tbodyEl.appendChild(this._renderRow(t))})}this._updateHeaderSelectionToggle(),this._applyColumnVisibility()}_parseMarkdownTables(t){const e=t.split(/\r?\n/),s=[];let r=0;const a=t=>/^\s*\|?\s*:?-{3,}:?\s*(\|\s*:?-{3,}:?\s*)+\|?\s*$/.test(t),i=t=>{const e=[];let s="",r=!1;t=t.replace(/^\s*\|?\s*/,"").replace(/\s*\|?\s*$/,"");for(let a of t)r?(s+=a,r=!1):"\\"!==a?"|"!==a?s+=a:(e.push(s.trim()),s=""):r=!0;return e.push(s.trim()),e};for(;r<e.length;){for(;r<e.length&&!/\|/.test(e[r]);)r++;if(r>=e.length)break;const t=e[r++];if(r>=e.length)break;if(!a(e[r]))continue;r++;const o=i(t),n=[];for(;r<e.length&&/\|/.test(e[r])&&!/^\s*$/.test(e[r]);){const t=i(e[r]);t.length>=1&&n.push(t),r++}const l=o.length,h=n.map(t=>{const e=t.slice(0,l);for(;e.length<l;)e.push("");return e});s.push({headers:o,rows:h})}return s}_mdInlineToHtml(t){let e=String(t??"");return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=e.replace(/!\[([^\]]*)\]\(([^\)\s]+)(?:\s+"([^"]+)")?\)/g,(t,e,s)=>`<img src="${this._escAttr(s)}" alt="${this._escAttr(e)}" loading="lazy" class="vg-img" />`),e=e.replace(/\[([^\]]+)\]\(([^\)\s]+)(?:\s+"([^"]+)")?\)/g,(t,e,s)=>`<a href="${this._escAttr(s)}" target="_blank" rel="noopener noreferrer" class="vg-link">${e}</a>`),e=e.replace(/\*\*([^*]+)\*\*/g,"<b>$1</b>").replace(/\*([^*]+)\*/g,"<i>$1</i>").replace(/`([^`]+)`/g,"<code>$1</code>"),e}_slugify(t){return String(t).toLowerCase().trim().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")||"col"}_uniqueKeys(t){const e=[],s=new Map;return t.forEach(t=>{let r=t||"col",a=s.get(r)||0,i=r;a>0&&(i=`${r}_${a}`),s.set(r,a+1),e.push(i)}),e}_exportMatrix(){const t=this.columns.filter(t=>!this.state.hiddenCols.has(t.key)),e=t.map(t=>String(t.label??t.key)),s=this.opts.exporting&&this.opts.exporting.scope||"page";if(this.opts.tree.enabled){const r=this._filterSortTreeFlatten();return{headers:e,rows:("page"===s?r.slice((this.state.page-1)*this.state.pageSize,(this.state.page-1)*this.state.pageSize+this.state.pageSize):r).map(e=>t.map(t=>this._cellText(e.row,t)))}}const{rows:r,groups:a,hasGroups:i}=this._filterSortGroup();if(i){const r="page"===s?a.slice((this.state.page-1)*this.state.pageSize,(this.state.page-1)*this.state.pageSize+this.state.pageSize):a,i=[];return r.forEach(e=>{e.rows.forEach(e=>i.push(t.map(t=>this._cellText(e,t))))}),{headers:e,rows:i}}return{headers:e,rows:("page"===s?r.slice((this.state.page-1)*this.state.pageSize,(this.state.page-1)*this.state.pageSize+this.state.pageSize):r).map(e=>t.map(t=>this._cellText(e,t)))}}_toCSV(t){const e=t=>{const e=String(t??"");return/[",\n]/.test(e)?'"'+e.replace(/"/g,'""')+'"':e};return t.map(t=>t.map(e).join(",")).join("\n")}_toMarkdown(t,e){const s=t=>"| "+t.map(t=>String(t??"").replace(/\n/g," ")).join(" | ")+" |",r="| "+t.map(()=>"---").join(" | ")+" |";return[s(t),r,...e.map(s)].join("\n")}_downloadBlob(t,e,s){const r=new Blob([t],{type:s}),a=URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download=e,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(a)},0)}_renderRow(t,e=0,s=null){const r=document.createElement("tr");if(r.className="vg-tr",r.dataset.rowid=t.__vgid,this.opts.selectable){const e=document.createElement("td");e.className="vg-td vg-td-select";const s=document.createElement("input");s.type="checkbox",s.className="vg-select-row",s.checked=this.state.selected.has(t.__vgid),s.onchange=()=>{s.checked?this.state.selected.add(t.__vgid):this.state.selected.delete(t.__vgid),this._updateHeaderSelectionToggle(),this._emitSelection()},e.appendChild(s),r.appendChild(e)}return this.columns.forEach((e,a)=>{const i=document.createElement("td");if(i.className="vg-td",i.dataset.key=e.key,this.opts.tree.enabled&&0===a){i.classList.add("vg-tree-cell");const e=this._renderTreeToggle(t,s);e&&i.appendChild(e)}this._renderCell(i,t,e),r.appendChild(i)}),r}_renderCell(t,e,s){if("function"==typeof s.render){t.innerHTML="";const r=s.render(e[s.key],e,s);return void(r instanceof Node?t.appendChild(r):t.innerHTML=r??"")}const r=(s.type||"text").toLowerCase(),a=e[s.key],i=!!t.querySelector&&!!t.querySelector(".vg-tree-toggle");switch(r){case"number":{const r=this._toNumber(a),o="function"==typeof s.format?s.format(r,e):r??"";if(i){const e=document.createElement("span");e.textContent=o,t.appendChild(e)}else t.textContent=o;t.classList.add("vg-num");break}case"html":if(i){const e=document.createElement("span");e.innerHTML=a??"",t.appendChild(e)}else t.innerHTML=a??"";break;case"image":{const e=document.createElement("img");e.src=String(a||""),e.alt=s.image&&s.image.alt||"",s.image&&s.image.width&&(e.width=s.image.width),s.image&&s.image.height&&(e.height=s.image.height),e.loading="lazy",e.className="vg-img",t.appendChild(e);break}case"link":{const e=document.createElement("a"),r=String(a||""),i=s.link&&s.link.text||r;e.href=r,e.target=s.link&&s.link.target||"_blank",e.rel="noopener noreferrer",e.textContent=i,e.className="vg-link",t.appendChild(e);break}case"button":{const r=document.createElement("button");r.className="vg-btn",r.dataset.rowid=e.__vgid,r.dataset.colkey=s.key,r.type="button",r.textContent=s.button&&s.button.text||"Action",t.appendChild(r);break}default:{const r="function"==typeof s.format?s.format(a,e):a??"";if(i){const e=document.createElement("span");e.textContent=r,t.appendChild(e)}else t.textContent=r}}}_renderTreeToggle(t,e){const s=this.opts.tree;if(!s.enabled)return null;const r=!(e&&null!=e.hasChildren?e.hasChildren:this._rowHasChildren(t)||this._rowPotentialChildren(t)),a=document.createElement("button");a.type="button",a.className="vg-tree-toggle",a.dataset.rowid=t.__vgid;const i=e?.depth||0;if(a.style.marginLeft=(Number(s.indent)||16)*i+"px",r)return a.classList.add("is-leaf"),a.innerHTML='<span class="vg-tree-spacer"></span>',a.disabled=!0,a;const o=this.state.loadingChildren.has(t.__vgid),n=this.state.expanded.has(t.__vgid);return a.classList.toggle("is-expanded",n),a.classList.toggle("is-loading",o),a.setAttribute("aria-label",n?this.opts.i18n.aria.collapseRow:this.opts.i18n.aria.expandRow),a.setAttribute("aria-expanded",n?"true":"false"),a.innerHTML=o?'<span class="vg-spinner"></span>':'<span class="vg-caret" aria-hidden="true"></span>',a}_renderAggSummary(t){const e=t.rows.length,s=[`<span class="vg-chip">${this._esc(this.opts.i18n.group.count)}: ${e}</span>`];return this.columns.filter(t=>Array.isArray(t.aggregations)&&t.aggregations.length).forEach(e=>{const r=t.aggregates[e.key]||{},a=e.aggregations,i=[];a.includes("sum")&&null!=r.sum&&i.push(`Σ ${this._fmtAgg(e,r.sum)}`),a.includes("min")&&null!=r.min&&i.push(`min ${this._fmtAgg(e,r.min)}`),a.includes("max")&&null!=r.max&&i.push(`max ${this._fmtAgg(e,r.max)}`),i.length&&s.push(`<span class="vg-chip">${this._esc(e.label??e.key)}: ${this._esc(i.join(" · "))}</span>`)}),s.length?`<div class="vg-agg">${s.join("")}</div>`:""}_fmtAgg(t,e){if("function"==typeof t.format)try{return t.format(e)}catch{return String(e)}return"number"==typeof e?e:String(e)}_headerLabelForGroup(t){const e=this.columns.find(t=>t.key===this.state.groupBy);return`${e?e.label??e.key:this.state.groupBy}: ${t.value}`}_renderPager(){if(!this.opts.pagination)return void(this.pagerEl.innerHTML="");const t=this.opts.serverPagination,{hasGroups:e,totalPages:s,totalCount:r}=t?this._processMetaRemote():this._processMeta(),a=Math.min(this.state.page,s||1),i=a<=1?"disabled":"",o=a>=s?"disabled":"",n=i,l=o;this.pagerEl.innerHTML=`\n        <div class="vg-pager-row">\n      <div class="vg-pager-left">\n        <button class="vg-page-btn" data-action="first" ${n} aria-label="${this._escAttr(this.opts.i18n.pager.first)}" title="${this._escAttr(this.opts.i18n.pager.first)}">«</button>\n        <button class="vg-page-btn" data-action="prev" ${i} aria-label="${this._escAttr(this.opts.i18n.pager.prev)}" title="${this._escAttr(this.opts.i18n.pager.prev)}">‹</button>\n      </div>\n      <span class="vg-page-info" aria-live="polite">${this._esc(this.opts.i18n.pager.pageInfo(a,s||1))}</span>\n      <div class="vg-pager-right">\n        <button class="vg-page-btn" data-action="next" ${o} aria-label="${this._escAttr(this.opts.i18n.pager.next)}" title="${this._escAttr(this.opts.i18n.pager.next)}">›</button>\n        <button class="vg-page-btn" data-action="last" ${l} aria-label="${this._escAttr(this.opts.i18n.pager.last)}" title="${this._escAttr(this.opts.i18n.pager.last)}">»</button>\n      </div>\n      <span class="vg-total">${this._esc(e?this.opts.i18n.pager.totalGroups(r):this.opts.i18n.pager.totalRows(r))}</span>\n        </div>\n      `,this.state.page=a,this.pagerEl.querySelector('[data-action="first"]').onclick=()=>{1!==this.state.page&&(this.state.page=1,t?this._remoteLoad(this.state.page):(this._renderBody(),this._renderPager()))},this.pagerEl.querySelector('[data-action="prev"]').onclick=()=>{this.state.page>1&&(this.state.page--,t?this._remoteLoad(this.state.page):(this._renderBody(),this._renderPager()))},this.pagerEl.querySelector('[data-action="next"]').onclick=()=>{this.state.page<s&&(this.state.page++,t?this._remoteLoad(this.state.page):(this._renderBody(),this._renderPager()))},this.pagerEl.querySelector('[data-action="last"]').onclick=()=>{this.state.page!==s&&(this.state.page=s,t?this._remoteLoad(this.state.page):(this._renderBody(),this._renderPager()))}}_processMeta(){if(this.opts.tree.enabled){const t=this._filterSortTreeFlatten().length;return{hasGroups:!1,totalPages:Math.max(1,Math.ceil(t/this.state.pageSize)),totalCount:t}}const{rows:t,groups:e,hasGroups:s}=this._filterSortGroup();if(!this.opts.pagination)return{hasGroups:s,totalPages:1,totalCount:s?e.length:t.length};const r=s?e.length:t.length;return{hasGroups:s,totalPages:Math.max(1,Math.ceil(r/this.state.pageSize)),totalCount:r}}_process(){if(this.opts.tree.enabled){const t=this._filterSortTreeFlatten();if(!this.opts.pagination)return{hasGroups:!1,pageFlatRows:t};const{page:e,pageSize:s}=this.state,r=(e-1)*s;return{hasGroups:!1,pageFlatRows:t.slice(r,r+s)}}const{rows:t,groups:e,hasGroups:s}=this._filterSortGroup();if(!this.opts.pagination)return s?{hasGroups:s,pageGroups:e}:{hasGroups:s,pageRows:t};const{page:r,pageSize:a}=this.state;if(s){const t=(r-1)*a;return{hasGroups:s,pageGroups:e.slice(t,t+a)}}{const e=(r-1)*a;return{hasGroups:s,pageRows:t.slice(e,e+a)}}}_filterSortTreeFlatten(){const t=this.opts.tree.childrenKey,e=this.data.slice(),{sortKey:s,sortDir:r}=this.state,a=s?this.columns.find(t=>t.key===s):null,i=(a?.type||"text").toLowerCase(),o=this.opts.sortable&&a&&!this.opts.serverSorting,n=(t,e)=>this._compare(t,e,i,a||{}),l=e=>{if(Array.isArray(e)){if(o){const t="desc"===r?-1:1;e.sort((e,r)=>t*n(e[s],r[s]))}e.forEach(e=>l(e[t]))}};l(e);const h=String(this.state.filter||"");let c=null;if(h){if(this.state.regexMode)try{c={type:"regex",rx:new RegExp(h,"i")},this.state.regexError=""}catch(t){this.state.regexError=String(t?.message||"Invalid RegExp")}else this.state.regexError="",c={type:"text",needle:h.toLowerCase()};this._renderToolbar()}const d=t=>{if(!c)return!0;if("regex"===c.type)return this.columns.some(e=>c.rx.test(this._cellText(t,e)));const e=c.needle;return this.columns.some(s=>this._cellText(t,s).toLowerCase().includes(e))},p=new Set,g=(e,s)=>{const r=Array.isArray(e[t])?e[t]:[];let a=d(e);return r.forEach(t=>{g(t,s.concat(e))&&(a=!0)}),c&&!a||(p.add(e),s.forEach(t=>p.add(t))),a};e.forEach(t=>g(t,[]));const u=[],m=(e,s)=>{Array.isArray(e)&&e.forEach(e=>{if(!p.has(e))return;const r=e.__vgid,a=this._rowHasChildren(e)||this._rowPotentialChildren(e),i=this.state.expanded.has(r)||!!c||this.opts.tree.initiallyExpanded;u.push({row:e,depth:s,hasChildren:a,expanded:i}),i&&Array.isArray(e[t])&&m(e[t],s+1)})};return m(e,0),u}_assignIdsDeep(t){if(!Array.isArray(t))return;const e=this.opts.tree.childrenKey;t.forEach(t=>{null==t.__vgid&&(t.__vgid=this._idCounter++),Array.isArray(t[e])&&this._assignIdsDeep(t[e])})}_indexRowsDeep(t){if(!Array.isArray(t))return;const e=this.opts.tree.childrenKey;t.forEach(t=>{this.rowById.set(t.__vgid,t),Array.isArray(t[e])&&this._indexRowsDeep(t[e])})}_rowHasChildren(t){const e=this.opts.tree.childrenKey;return Array.isArray(t?.[e])&&t[e].length>0}_rowPotentialChildren(t){const e=this.opts.tree.hasChildrenKey;return!!t&&!!t[e]}_shouldRemoteFetch(t){return"function"==typeof this.opts.loadPage&&(!!this.opts.serverPagination||(!(!this.opts.serverSorting||"sort"!==t)||(!(!this.opts.serverFiltering||"filter"!==t)||("init"===t?this.opts.serverPagination||this.opts.serverSorting||this.opts.serverFiltering:"page"===t&&this.opts.serverPagination))))}_processMetaRemote(){const t=this.state.serverTotalRows??this.data.length;return{hasGroups:!1,totalPages:Math.max(1,Math.ceil(t/this.state.pageSize)),totalCount:t}}_remoteLoad(t){if("function"!=typeof this.opts.loadPage)return this._renderBody(),void this._renderPager();const e={page:t||this.state.page||1,pageSize:this.state.pageSize,sortKey:this.state.sortKey,sortDir:this.state.sortDir,filter:this.state.filter,regexMode:this.state.regexMode};Promise.resolve(this.opts.loadPage(e)).then(t=>{const s=Array.isArray(t?.rows)?t.rows:[],r=Number.isFinite(t?.total)?t.total:s.length;this._idCounter=0,this._assignIdsDeep(s),this.data=s,this.rowById=new Map,this._indexRowsDeep(this.data),this.state.serverTotalRows=r,this.state.page=e.page}).finally(()=>{this._renderBody(),this._renderPager()})}_filterSortGroup(){let t=this.data.slice();const e=String(this.state.filter||"");if(e){if(this.state.regexMode)try{const s=new RegExp(e,"i");this.state.regexError="",t=t.filter(t=>this.columns.some(e=>s.test(this._cellText(t,e))))}catch(t){this.state.regexError=String(t?.message||"Invalid RegExp")}else{this.state.regexError="";const s=e.toLowerCase();t=t.filter(t=>this.columns.some(e=>this._cellText(t,e).toLowerCase().includes(s)))}this._renderToolbar()}const{sortKey:s,sortDir:r}=this.state;if(s){const e=this.columns.find(t=>t.key===s);if(e){const s="desc"===r?-1:1,a=(e.type||"text").toLowerCase(),i=(t,s)=>this._compare(t,s,a,e);t.sort((t,r)=>s*i(t[e.key],r[e.key]))}}const a=this.state.groupBy;if(!a)return{hasGroups:!1,rows:t};const i=new Map;t.forEach(t=>{const e=null==t[a]?"(null)":String(t[a]);i.has(e)||i.set(e,[]),i.get(e).push(t)});const o=[];for(const[t,e]of i.entries())o.push({value:t,rows:e,aggregates:this._computeAggregates(e)});return{hasGroups:!0,groups:o}}_computeAggregates(t){const e={};return this.columns.forEach(s=>{if(!Array.isArray(s.aggregations)||0===s.aggregations.length)return;const r=t.map(t=>this._toNumber(t[s.key])).filter(t=>"number"==typeof t&&!Number.isNaN(t));if(!r.length)return;const a={};s.aggregations.includes("sum")&&(a.sum=r.reduce((t,e)=>t+e,0)),s.aggregations.includes("min")&&(a.min=Math.min(...r)),s.aggregations.includes("max")&&(a.max=Math.max(...r)),e[s.key]=a}),e}_cellText(t,e){if("function"==typeof e.render)try{const s=e.render(t[e.key],t,e);return s instanceof Node?(s.textContent||"").trim():String(s??"")}catch{return""}const s=(e.type||"text").toLowerCase(),r=t[e.key];switch(s){case"number":return String(this._toNumber(r)??"");case"html":{const t=document.createElement("div");return t.innerHTML=String(r??""),(t.textContent||"").trim()}case"image":default:return String(r??"");case"link":{const t=String(r??"");return(e.link&&e.link.text||t)+" "+t}case"button":return e.button&&e.button.text||"Action"}}_compare(t,e,s,r){if("function"==typeof r.sort)try{return r.sort(t,e)}catch{}if(null==t&&null==e)return 0;if(null==t)return-1;if(null==e)return 1;switch(s){case"number":{const s=this._toNumber(t),r=this._toNumber(e);return s===r?0:s<r?-1:1}case"html":{const s=this._stripHtml(String(t)),r=this._stripHtml(String(e));return s.localeCompare(r,void 0,{sensitivity:"base",numeric:!0})}default:{const s=String(t),r=String(e);return s.localeCompare(r,void 0,{sensitivity:"base",numeric:!0})}}}_toNumber(t){if("number"==typeof t)return t;if("string"==typeof t){const e=t.replace(/[^\d.+-]/g,""),s=parseFloat(e);return Number.isNaN(s)?void 0:s}}_stripHtml(t){return t.replace(/<[^>]*>/g,"")}_esc(t){return String(t??"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]))}_escAttr(t){return this._esc(t).replace(/"/g,"&quot;")}_colCount(){return this.columns.length+(this.opts.selectable?1:0)}_currentPageRowIds(){const t=[];if(this.opts.tree.enabled){(this._process().pageFlatRows||[]).forEach(e=>t.push(e.row.__vgid))}else{const{hasGroups:e,pageRows:s,pageGroups:r}=this._process();e?(r||[]).forEach(e=>e.rows.forEach(e=>t.push(e.__vgid))):(s||[]).forEach(e=>t.push(e.__vgid))}return t}_updateHeaderSelectionToggle(){if(!this.opts.selectable)return;const t=this.theadEl.querySelector(".vg-select-all");if(!t)return;const e=this._currentPageRowIds(),s=e.filter(t=>this.state.selected.has(t));t.checked=e.length>0&&s.length===e.length,t.indeterminate=s.length>0&&s.length<e.length}_emitSelection(){if("function"==typeof this.opts.onSelectionChange){const t=Array.from(this.state.selected).map(t=>this.rowById.get(t)).filter(Boolean);try{this.opts.onSelectionChange(t)}catch{}}}_applyColumnVisibility(){const t=this.state.hiddenCols;this.theadEl.querySelectorAll(".vg-th").forEach(e=>{const s=e.dataset.key;s&&(e.style.display=t.has(s)?"none":"")}),this.tbodyEl.querySelectorAll(".vg-td").forEach(e=>{const s=e.dataset.key;s&&(e.style.display=t.has(s)?"none":"")})}getSelectedRows(){return Array.from(this.state.selected).map(t=>this.rowById.get(t)).filter(Boolean)}clearSelection(){this.state.selected.clear(),this._updateHeaderSelectionToggle(),this._renderBody(),this._emitSelection()}}"undefined"!=typeof module&&void 0!==module.exports?module.exports=e:t.VanillaGrid=e}("undefined"!=typeof window?window:globalThis);