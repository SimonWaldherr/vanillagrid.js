/*!
 * VanillaGrid — a tiny table library
 * Features: sorting, multiple filtering modes (simple/CS/RegExp/tree),
 * pagination, grouping (sum/min/max), selection, resizing, basic editing,
 * context menu, export, tree data, and optional pivot-like view.
 * No dependencies. MIT License.
 *
 * Usage:
 *   const grid = new VanillaGrid('#el', { data, columns, filterable: true });
 *   grid.setFilter('term');
 *   grid.setSort('name', 'asc');
 *   grid.setGroupBy('department');
 *
 * Public API (selected):
 *   - setData(data:Array<object>)
 *   - getData(): Array<object>
 *   - setFilter(text:string, opts?:{ regexMode?:boolean, caseSensitive?:boolean })
 *   - setSort(key:string, dir:'asc'|'desc')
 *   - setGroupBy(key?:string)
 *
 * The code aims to keep DOM re-renders scoped (header/body/pager/toolbar)
 * and uses delegated event listeners to avoid stacking across re-renders.
 */
!function(t){class e{constructor(t,e){if(this.container="string"==typeof t?document.querySelector(t):t,!this.container)throw new Error("VanillaGrid: container not found");const s={data:[],columns:[],pageSize:10,pageSizes:[10,25,50,100,1e3],sortable:!0,filterable:!1,pagination:!0,groupable:!1,groupBy:null,regexFilter:!1,className:"",emptyMessage:"No rows to display.",i18n:{tableLabel:"Data table",filterPlaceholder:"Filter...",regexLabel:"RegExp",invalidRegex:"Invalid RegExp",noGroup:"No group",groupByPrefix:"Group by",perPageSuffix:" / page",search:{simple:"Simple",caseSensitive:"Case-sensitive",regex:"RegExp",treeFilter:"Tree/Filter"},pager:{pageInfo:(t,e)=>`Page ${t} of ${e}`,prev:"Previous page",next:"Next page",first:"First page",last:"Last page",totalRows:t=>`${t} row(s)`,totalGroups:t=>`${t} group(s)`},group:{count:"Count",min:"min",max:"max"},aria:{toggleGroup:"Toggle group",expandRow:"Expand",collapseRow:"Collapse"},export:{button:"Export",csv:"CSV",markdown:"Markdown",format:"Format"}},tree:{enabled:!1,childrenKey:"children",indent:16,lazy:!1,initiallyExpanded:!1,hasChildrenKey:"hasChildren"},loadChildren:null,serverPagination:!1,serverSorting:!1,serverFiltering:!1,loadPage:null,exporting:{enabled:!1,formats:["csv","md"],scope:"page",filename:"vanillagrid"},selectable:!1,onSelectionChange:null,columnsMenu:!1,onColumnsVisibilityChange:null,resizableColumns:!1,editableRows:!1,rowDragDrop:!1,frozenColumns:0,keyboardNavigation:!0,contextMenu:!0,onRowEdit:null,onRowDrop:null,customCellTypes:{},pivotMode:!1,pivotConfig:{rows:[],columns:[],values:[],aggregations:{}},onPivotChange:null};this.opts=Object.assign({},s,e||{}),e&&e.tree&&(this.opts.tree=Object.assign({},s.tree,e.tree)),this.columns=this.opts.columns,this.data=Array.isArray(this.opts.data)?this.opts.data.slice():[],this._idCounter=0,this._assignIdsDeep(this.data),this.rowById=new Map,this._indexRowsDeep(this.data),this.state={sortKey:null,sortDir:"asc",filter:"",filterMode:"simple",regexMode:!!this.opts.regexFilter,caseSensitive:!1,treeFilterExpanded:new Set,page:1,pageSize:this.opts.pageSize,groupBy:this.opts.groupBy,regexError:"",collapsed:new Set,expanded:new Set,loadingChildren:new Set,serverTotalRows:null,selected:new Set,hiddenCols:new Set,columnWidths:new Map,editingCell:null,draggedRow:null,focusedCell:null,pivotData:null,originalData:null,originalColumns:null,pivotControlsCollapsed:!1},this.root=document.createElement("div"),this.root.className=`vg-container ${this.opts.className}`.trim(),this.container.innerHTML="",this.container.appendChild(this.root),this._render()}setData(t){this.data=Array.isArray(t)?t.slice():[],this._idCounter=0,this._assignIdsDeep(this.data),this.rowById=new Map,this._indexRowsDeep(this.data),this.state.page=1,this._renderBody(),this._renderPager()}getData(){return this.data.slice()}setGroupBy(t){this.state.groupBy=t||null,this.state.page=1,this._renderBody(),this._renderPager()}setFilter(t,e={}){this.state.filter=t??"",null!=e.regexMode&&(this.state.regexMode=!!e.regexMode),null!=e.caseSensitive&&(this.state.caseSensitive=!!e.caseSensitive),this.state.page=1,this._updateFilterError(),this._shouldRemoteFetch("filter")?this._remoteLoad(1):(this._renderBody(),this._renderPager())}setSort(t,e="asc"){this.state.sortKey=t,this.state.sortDir="desc"===e?"desc":"asc",this._renderHeader(),this._shouldRemoteFetch("sort")?this._remoteLoad(1):this._renderBody()}setPageSize(t){this.state.pageSize=+t||10,this.state.page=1,this._renderPager(),this._shouldRemoteFetch("page")?this._remoteLoad(1):this._renderBody()}setMarkdown(t,e={}){const s=this._parseMarkdownTables(String(t||"")),i=s[Math.max(0,Math.min(e.tableIndex||0,s.length-1))];if(!i)return this.columns=[],void this.setData([]);const a=this._uniqueKeys(i.headers.map(t=>this._slugify(String(t||"col")))),o=a.map((t,e)=>({key:t,label:i.headers[e],type:"html",sortable:!0})),n=i.rows.map(t=>{const e={};return t.forEach((t,s)=>e[a[s]]=this._mdInlineToHtml(t)),e});this.columns=o,this._renderHeader(),this.setData(n)}async loadMarkdown(t,e){const s=await fetch(t,e),i=await s.text();this.setMarkdown(i)}downloadCSV(t){const e=(t||this.opts.exporting.filename||"vanillagrid")+".csv",{headers:s,rows:i}=this._exportMatrix(),a=this._toCSV([s,...i]);this._downloadBlob(a,e,"text/csv;charset=utf-8;")}downloadMarkdown(t){const e=(t||this.opts.exporting.filename||"vanillagrid")+".md",{headers:s,rows:i}=this._exportMatrix(),a=this._toMarkdown(s,i);this._downloadBlob(a,e,"text/markdown;charset=utf-8;")}addRow(t,e=-1){const s={...t};return this._assignIdsDeep([s]),this._indexRowsDeep([s]),e>=0&&e<this.data.length?this.data.splice(e,0,s):this.data.push(s),this._renderBody(),this._renderPager(),s}updateRow(t,e){const s=this.rowById.get(t);return s?(Object.assign(s,e),this._renderBody(),s):null}deleteRow(t){const e=this.data.findIndex(e=>e.__vgid===t);if(e>-1){const s=this.data.splice(e,1)[0];return this.rowById.delete(t),this.state.selected.delete(t),this._renderBody(),this._renderPager(),s}return null}setColumnWidth(t,e){this.state.columnWidths.set(t,e),this._renderHeader()}getColumnWidth(t){return this.state.columnWidths.get(t)}resetColumnWidths(){this.state.columnWidths.clear(),this._renderHeader()}startEdit(t,e){const s=this.root.querySelector(`tr[data-rowid="${t}"]`);if(s){const t=s.querySelector(`td[data-column-key="${e}"]`);if(t)return this._startCellEdit(t),!0}return!1}focusCell(t,e){const s=this.root.querySelector(`tr[data-rowid="${t}"]`);if(s){const i=s.querySelector(`td[data-column-key="${e}"]`);if(i)return i.focus(),this.state.focusedCell={rowId:t,columnKey:e},!0}return!1}registerCellType(t,e){this.opts.customCellTypes[t]=e}unregisterCellType(t){delete this.opts.customCellTypes[t]}enablePivot(t={}){this.opts.pivotMode||(this.state.originalData=this.data.slice(),this.state.originalColumns=this.columns.slice()),this.opts.pivotMode=!0,this.opts.pivotConfig={rows:t.rows||[],columns:t.columns||[],values:t.values||[],filters:t.filters||[],aggregations:t.aggregations||{}},this._generatePivotTable(),this._renderPivotToolbar(),this._renderHeader(),this._renderBody(),this._renderPager(),this.opts.onPivotChange&&this.opts.onPivotChange(this.state.pivotData,this.opts.pivotConfig)}disablePivot(){this.state.originalData&&this.state.originalColumns&&(this.data=this.state.originalData,this.columns=this.state.originalColumns,this.state.originalData=null,this.state.originalColumns=null),this.opts.pivotMode=!1,this.state.pivotData=null,this._renderToolbar(),this._renderHeader(),this._renderBody(),this._renderPager()}updatePivotConfig(t){this.opts.pivotMode&&(Object.assign(this.opts.pivotConfig,t),this._generatePivotTable(),this._updatePivotFieldLists(),this._renderHeader(),this._renderBody(),this.opts.onPivotChange&&this.opts.onPivotChange(this.state.pivotData,this.opts.pivotConfig))}getPivotData(){return this.state.pivotData}getAvailableFields(){const t=this.state.originalData||this.data;if(!t.length)return[];const e=t[0];return Object.keys(e).filter(t=>!t.startsWith("__vg"))}_render(){this.root.innerHTML=`\n        <div class="vg-toolbar"></div>\n        <div class="vg-table-wrap">\n      <table class="vg-table" role="table" aria-label="${this._escAttr(this.opts.i18n.tableLabel)}">\n            <thead></thead>\n            <tbody></tbody>\n          </table>\n        </div>\n        <div class="vg-pager"></div>\n      `,this.toolbarEl=this.root.querySelector(".vg-toolbar"),this.theadEl=this.root.querySelector("thead"),this.tbodyEl=this.root.querySelector("tbody"),this.pagerEl=this.root.querySelector(".vg-pager"),this.tableEl=this.root.querySelector(".vg-table"),this._renderToolbar(),this._renderHeader(),this._bindTableEvents(),this._bindKeyboardNavigation(),this._bindContextMenu(),this._restoreColumnsMenuState(),this._shouldRemoteFetch("init")?this._remoteLoad(1):(this._renderBody(),this._renderPager()),this._applyColumnVisibility()}_renderToolbar(){if(this.opts.pivotMode)return void this._renderPivotToolbar();const t=this.opts.filterable,e=this.opts.groupable,s=this.opts.i18n,i=this.opts.pageSizes,a=[`<option value="">${this._esc(s.noGroup)}</option>`].concat(this.columns.map(t=>`<option value="${this._esc(t.key)}" ${this.state.groupBy===t.key?"selected":""}>${this._esc(s.groupByPrefix)} ${this._esc(t.label??t.key)}</option>`)),o=(i.map(t=>`<option value="${t}" ${+this.state.pageSize===+t?"selected":""}>${t}${this._esc(s.perPageSuffix)}</option>`),this.opts.exporting&&this.opts.exporting.enabled?`<div class="vg-export">\n            <select class="vg-export-format" aria-label="${this._escAttr(s.export.format)}">\n              ${this.opts.exporting.formats.map(t=>"csv"===t?`<option value="csv">${this._esc(s.export.csv)}</option>`:`<option value="md">${this._esc(s.export.markdown)}</option>`).join("")}\n            </select>\n    <button class="vg-export-btn" type="button" aria-label="${this._escAttr(s.export.button)}" title="${this._escAttr(s.export.button)}">${this._esc(s.export.button)}</button>\n          </div>`:""),n=this._columnsMenuConfig(),r=n&&"toolbar"===n.location;this.toolbarEl.innerHTML=`\n        <div class="vg-toolbar-row">\n          ${t?`\n          <div class="vg-filter">\n            <input type="text" class="vg-filter-input" placeholder="${this._escAttr(s.filterPlaceholder)}" value="${this._escAttr(this.state.filter)}" aria-label="${this._escAttr(s.filterPlaceholder)}" />\n            <div class="vg-filter-mode">\n              <div class="vg-filter-mode-btn" aria-label="Filter mode">\n                <span class="vg-filter-mode-current">${this._esc(s.search[this.state.filterMode])}</span>\n              </div>\n              <div class="vg-filter-mode-dropdown">\n                <div class="vg-filter-mode-option ${"simple"===this.state.filterMode?"active":""}" data-mode="simple">\n                  ${this._esc(s.search.simple)}\n                </div>\n                <div class="vg-filter-mode-option ${"case-sensitive"===this.state.filterMode?"active":""}" data-mode="case-sensitive">\n                  ${this._esc(s.search.caseSensitive)}\n                </div>\n                <div class="vg-filter-mode-option ${"regex"===this.state.filterMode?"active":""}" data-mode="regex">\n                  ${this._esc(s.search.regex)}\n                </div>\n                <div class="vg-filter-mode-option ${"tree"===this.state.filterMode?"active":""}" data-mode="tree">\n                  ${this._esc(s.search.treeFilter)}\n                </div>\n              </div>\n            </div>\n            ${this.state.regexError?`<span class="vg-error" title="${this._escAttr(this.state.regexError)}">${this._esc(s.invalidRegex)}</span>`:""}\n            ${"tree"===this.state.filterMode?this._renderTreeFilter():""}\n          </div>`:""}\n          ${e?`\n          <div class="vg-groupby">\n            <select class="vg-group-select" aria-label="${this._escAttr(s.groupByPrefix)}">\n              ${a.join("")}\n            </select>\n          </div>`:""}\n          ${o}\n          ${r?this._columnsMenuMarkup(n):""}\n        </div>\n      `;const l=this.toolbarEl.querySelector(".vg-filter-input"),d=this.toolbarEl.querySelector(".vg-filter-mode-btn"),c=this.toolbarEl.querySelector(".vg-filter-mode"),h=this.toolbarEl.querySelector(".vg-group-select"),p=this.toolbarEl.querySelector(".vg-export-btn"),g=this.toolbarEl.querySelector(".vg-export-format");l&&(l.oninput=()=>{l.style.transform="scale(1.02)",setTimeout(()=>{l.style.transform=""},100),this._applyFilter()},l.onkeydown=t=>{switch(t.key){case"Escape":l.value="",this._applyFilter();break;case"ArrowDown":if("tree"===this.state.filterMode){t.preventDefault();const e=this.toolbarEl.querySelector(".vg-tree-filter-panel");if(e&&e.classList.contains("show")){const t=e.querySelector(".vg-tree-filter-column-name");t&&t.focus()}}break;case"F3":case"Enter":if(t.ctrlKey||t.metaKey){t.preventDefault();const e=["simple","case-sensitive","regex","tree"],s=e.indexOf(this.state.filterMode),i=e[(s+1)%e.length];this.state.filterMode=i,this.state.regexMode="regex"===i,this._renderToolbar(),this._applyFilter()}}},l.onfocus=()=>{"tree"!==this.state.filterMode||l.value||setTimeout(()=>this._renderToolbar(),100)}),d&&c&&this._setupFilterModeDropdown(d,c),h&&(h.onchange=()=>{this.state.groupBy=h.value||null,this.state.page=1,this.state.collapsed.clear(),this._renderBody(),this._renderPager()}),p&&g&&(p.onclick=()=>{"csv"===g.value?this.downloadCSV():this.downloadMarkdown()}),r&&this._bindColumnsMenuEvents(this.toolbarEl),this._bindTreeFilterEvents()}_setupFilterModeDropdown(t,e){t.onclick=t=>{t.stopPropagation();const s=e.classList.contains("open");document.querySelectorAll(".vg-filter-mode.open").forEach(t=>{t!==e&&t.classList.remove("open")}),e.classList.toggle("open"),s||setTimeout(()=>{const t=e.querySelector(".vg-filter-mode-option");t&&t.focus()},100)},this._onDocClickFilterMode&&document.removeEventListener("click",this._onDocClickFilterMode),this._onDocClickFilterMode=s=>{const i=s.target;e.contains(i)||t.contains(i)||e.classList.remove("open")},document.addEventListener("click",this._onDocClickFilterMode),e.addEventListener("keydown",s=>{const i=e.querySelectorAll(".vg-filter-mode-option"),a=Array.from(i).findIndex(t=>t===document.activeElement);switch(s.key){case"ArrowDown":s.preventDefault();i[(a+1)%i.length].focus();break;case"ArrowUp":s.preventDefault();i[(a-1+i.length)%i.length].focus();break;case"Enter":case" ":s.preventDefault(),document.activeElement.classList.contains("vg-filter-mode-option")&&document.activeElement.click();break;case"Escape":e.classList.remove("open"),t.focus()}}),e.addEventListener("click",t=>{const s=t.target.closest(".vg-filter-mode-option");if(!s)return;t.stopPropagation();const i=s.dataset.mode;s.style.transform="scale(0.95)",setTimeout(()=>{s.style.transform=""},150),this.state.filterMode=i,this.state.regexMode="regex"===i,e.classList.remove("open"),this._renderToolbar(),this._applyFilter(),setTimeout(()=>{const t=this.toolbarEl.querySelector(".vg-filter-input");t&&t.focus()},100)}),e.querySelectorAll(".vg-filter-mode-option").forEach(t=>{t.setAttribute("tabindex","0")})}_applyFilter(){const t=this.toolbarEl.querySelector(".vg-filter-input");if(!t)return;const e=t.value,s=this.state.filterMode;"regex"===s?this.setFilter(e,{regexMode:!0}):"tree"===s?(this.state.filter=e,this.state.page=1,this._renderBody(),this._renderPager()):this.setFilter(e,{regexMode:!1,caseSensitive:"case-sensitive"===s})}_renderTreeFilter(){if("tree"!==this.state.filterMode)return"";const t=this._getColumnValueStats();return`<div class="vg-tree-filter-panel show">\n        <div class="vg-tree-filter-header">Explore Data by Column Values</div>\n        ${Object.entries(t).filter(([t,e])=>Object.values(e).some(t=>t>1)).map(([t,e])=>{const s=this.columns.find(e=>e.key===t),i=s?s.label||s.key:t,a=this.state.treeFilterExpanded.has(t),o=Object.entries(e).filter(([,t])=>t>1).sort(([,t],[,e])=>e-t).slice(0,10).map(([e,s])=>`<div class="vg-tree-filter-value" data-column="${t}" data-value="${this._escAttr(e)}">\n                <span class="vg-tree-filter-value-text">${this._esc(String(e))}</span>\n                <span class="vg-tree-filter-value-count">${s}</span>\n              </div>`).join("");return`<div class="vg-tree-filter-column ${a?"expanded":""}">\n            <div class="vg-tree-filter-column-name" data-column="${t}">\n              ${this._esc(i)}\n            </div>\n            <div class="vg-tree-filter-values">${o}</div>\n          </div>`}).join("")}\n      </div>`}_getColumnValueStats(){const t={};return this.columns.forEach(e=>{t[e.key]={}}),this.data.forEach(e=>{this.columns.forEach(s=>{const i=e[s.key],a=String(i||"(empty)");t[s.key][a]||(t[s.key][a]=0),t[s.key][a]++})}),t}_bindTreeFilterEvents(){this.toolbarEl&&(this._onToolbarTreeClick&&this.toolbarEl.removeEventListener("click",this._onToolbarTreeClick),this._onToolbarTreeClick=t=>{const e=t.target.closest(".vg-tree-filter-column-name");if(e){const t=e.dataset.column,s=e.closest(".vg-tree-filter-column");return void(this.state.treeFilterExpanded.has(t)?(this.state.treeFilterExpanded.delete(t),s&&s.classList.remove("expanded")):(this.state.treeFilterExpanded.add(t),s&&s.classList.add("expanded")))}const s=t.target.closest(".vg-tree-filter-value");if(s){const t=s.dataset.column,e=s.dataset.value,i=this.toolbarEl.querySelector(".vg-filter-input");if(i){i.value=`${t}:"${e}"`,this._applyFilter();const s=this.toolbarEl.querySelector(".vg-tree-filter-panel");s&&s.classList.remove("show"),setTimeout(()=>{i.focus(),i.setSelectionRange(i.value.length,i.value.length)},100)}}},this.toolbarEl.addEventListener("click",this._onToolbarTreeClick))}_columnsMenuConfig(){if(!1===this.opts.columnsMenu)return null;const t=!0===this.opts.columnsMenu?{}:this.opts.columnsMenu||{};return Object.assign({},{location:"pager",label:"Columns",showSearch:!1,showSelectAll:!0,include:null,exclude:null,persistKey:null,initialHidden:null},t)}_columnsMenuMarkup(t){const e=t.label||"Columns",s=t.include?new Set(t.include):null,i=t.exclude?new Set(t.exclude):null,a=this.columns.filter(t=>!(s&&!s.has(t.key))&&(!i||!i.has(t.key))),o=a.map(t=>{const e=this.state.hiddenCols.has(t.key);return`<label style="display:flex;gap:6px;align-items:center;padding:4px 2px;">\n          <input type="checkbox" data-col-toggle value="${this._escAttr(t.key)}" ${e?"":"checked"} />\n          <span>${this._esc(t.label??t.key)}</span>\n        </label>`}).join(""),n=t.showSearch?'<input type="text" class="vg-cols-search" placeholder="Search columns" style="width:100%;padding:6px 8px;border:1px solid var(--vg-border);border-radius:6px;" />':"",r=t.showSelectAll?`<label style="display:flex;gap:6px;align-items:center;padding:4px 2px;">\n        <input type="checkbox" class="vg-cols-selectall" ${this._allVisible(a)?"checked":""} />\n        <span>Select all</span>\n      </label>`:"";return`\n        <details class="vg-cols">\n          <summary class="vg-btn" aria-haspopup="true">${this._esc(e)}</summary>\n          <div class="vg-cols-list" role="menu">\n            ${n}\n            ${r}\n            <div class="vg-cols-items">${o}</div>\n          </div>\n        </details>`}_allVisible(t){return t.every(t=>!this.state.hiddenCols.has(t.key))}_bindColumnsMenuEvents(t){const e=t.querySelector(".vg-cols-list");if(!e)return;const s=e.querySelector(".vg-cols-items")||e;s.querySelectorAll("input[data-col-toggle]").forEach(t=>{t.onchange=()=>{const e=t.value;t.checked?this.state.hiddenCols.delete(e):this.state.hiddenCols.add(e),this._applyColumnVisibility(),"function"==typeof this.opts.onColumnsVisibilityChange&&this.opts.onColumnsVisibilityChange(new Set(this.state.hiddenCols)),this._persistColumnsMenuState()}});const i=e.querySelector(".vg-cols-selectall");i&&(i.onchange=()=>{const t=i.checked;(this.columns||[]).forEach(e=>{t?this.state.hiddenCols.delete(e.key):this.state.hiddenCols.add(e.key)}),this._applyColumnVisibility(),"function"==typeof this.opts.onColumnsVisibilityChange&&this.opts.onColumnsVisibilityChange(new Set(this.state.hiddenCols)),this._persistColumnsMenuState(),s.querySelectorAll("input[data-col-toggle]").forEach(e=>{e.checked=t})});const a=e.querySelector(".vg-cols-search");a&&(a.oninput=()=>{const t=a.value.toLowerCase();s.querySelectorAll("label").forEach(e=>{const s=e.textContent.toLowerCase();e.style.display=s.includes(t)?"":"none"})})}_persistColumnsMenuState(){const t=this._columnsMenuConfig();if(t&&t.persistKey)try{const e=Array.from(this.state.hiddenCols);localStorage.setItem(`vg:hiddenCols:${t.persistKey}`,JSON.stringify(e))}catch{}}_restoreColumnsMenuState(){const t=this._columnsMenuConfig();if(t){if(t.persistKey)try{const e=localStorage.getItem(`vg:hiddenCols:${t.persistKey}`);if(e){const t=JSON.parse(e);return void(this.state.hiddenCols=new Set(Array.isArray(t)?t:[]))}}catch{}Array.isArray(t.initialHidden)&&(this.state.hiddenCols=new Set(t.initialHidden))}}_renderHeader(){const{sortKey:t,sortDir:e}=this.state,s=document.createElement("tr");if(this.opts.selectable){const t=document.createElement("th");t.className="vg-th";const e=document.createElement("input");e.type="checkbox",e.className="vg-select-all";const i=this._currentPageRowIds(),a=i.filter(t=>this.state.selected.has(t));e.checked=i.length>0&&a.length===i.length,e.indeterminate=a.length>0&&a.length<i.length,e.onchange=()=>{const t=this._currentPageRowIds();e.checked?t.forEach(t=>this.state.selected.add(t)):t.forEach(t=>this.state.selected.delete(t)),this._renderBody(),this._renderHeader(),this._emitSelection()},t.appendChild(e),s.appendChild(t)}this.columns.forEach((i,a)=>{const o=document.createElement("th");o.setAttribute("role","columnheader"),o.tabIndex=0,o.dataset.key=i.key,o.className="vg-th",this.state.columnWidths.has(i.key)&&(o.style.width=this.state.columnWidths.get(i.key)+"px"),this.opts.sortable&&!1!==i.sortable&&(o.classList.add("vg-sortable"),t===i.key&&o.classList.add("asc"===e?"vg-asc":"vg-desc"));let n=this._esc(i.label??i.key);if(this.opts.tree.enabled&&0===a&&(n=`<span class="vg-tree-th-pad"></span>${n}`),o.innerHTML=`<span class="vg-th-text">${n}</span>`,this.opts.resizableColumns&&a<this.columns.length-1){const t=document.createElement("div");t.className="vg-resize-handle",t.dataset.columnKey=i.key,o.appendChild(t)}this.opts.sortable&&!1!==i.sortable&&o.setAttribute("aria-sort",t===i.key?"asc"===e?"ascending":"descending":"none"),s.appendChild(o)}),this.theadEl.innerHTML="",this.theadEl.appendChild(s),this.theadEl.querySelectorAll(".vg-th.vg-sortable").forEach(t=>{t.onclick=e=>{if(e.target.closest(".vg-resize-handle"))return;const s=t.dataset.key;this.state.sortKey===s?this.state.sortDir="asc"===this.state.sortDir?"desc":"asc":(this.state.sortKey=s,this.state.sortDir="asc"),this._renderHeader(),this._shouldRemoteFetch("sort")?this._remoteLoad(1):this._renderBody()},t.onkeydown=e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.click())}}),this.opts.resizableColumns&&this._bindColumnResize()}_bindTableEvents(){this.tableEl.addEventListener("click",t=>{const e=t.target.closest(".vg-btn");if(e){const t=e.dataset.rowid,s=e.dataset.colkey,i=this.rowById.get(Number(t)),a=this.columns.find(t=>t.key===s);i&&a&&a.button&&"function"==typeof a.button.onClick&&a.button.onClick(i,e)}const s=t.target.closest(".vg-group-header");if(s){const t=s.dataset.groupValue;this.state.collapsed.has(t)?this.state.collapsed.delete(t):this.state.collapsed.add(t);const e=this.tbodyEl.querySelectorAll(`tr[data-group="${CSS.escape(t)}"]`),i=this.state.collapsed.has(t);e.forEach(t=>t.style.display=i?"none":""),s.classList.toggle("is-collapsed",i),s.setAttribute("aria-expanded",i?"false":"true")}const i=t.target.closest(".vg-tree-toggle");if(i){const t=Number(i.dataset.rowid),e=this.rowById.get(t);if(!e)return;if(this.state.expanded.has(t))this.state.expanded.delete(t),this._renderBody();else{this.opts.tree.enabled&&this.opts.tree.lazy&&!this._rowHasChildren(e)&&this._rowPotentialChildren(e)&&"function"==typeof this.opts.loadChildren?(this.state.loadingChildren.add(t),this._renderBody(),Promise.resolve().then(()=>this.opts.loadChildren(e)).then(t=>{const s=this.opts.tree.childrenKey;e[s]=Array.isArray(t)?t:[],this._assignIdsDeep(e[s]),this._indexRowsDeep(e[s])}).finally(()=>{this.state.loadingChildren.delete(t),this.state.expanded.add(t),this._renderBody()})):(this.state.expanded.add(t),this._renderBody())}}})}_bindColumnResize(){this.theadEl.querySelectorAll(".vg-resize-handle").forEach(t=>{t.addEventListener("mousedown",e=>{e.preventDefault(),e.stopPropagation();const s=t.dataset.columnKey,i=t.closest("th"),a=e.clientX,o=i.offsetWidth,n=t=>{const e=Math.max(50,o+(t.clientX-a));this.state.columnWidths.set(s,e),i.style.width=e+"px"},r=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r),document.body.classList.remove("vg-resizing")};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r),document.body.classList.add("vg-resizing")})})}_bindKeyboardNavigation(){this.opts.keyboardNavigation&&this.tableEl.addEventListener("keydown",t=>{const e=t.target.closest("td, th");if(!e)return;const s=e.closest("tr"),i=Array.from(s.children),a=Array.from(this.tbodyEl.children);let o=i.indexOf(e),n=a.indexOf(s);switch(t.key){case"ArrowRight":t.preventDefault(),o<i.length-1&&i[o+1].focus();break;case"ArrowLeft":t.preventDefault(),o>0&&i[o-1].focus();break;case"ArrowDown":if(t.preventDefault(),n<a.length-1){const t=Array.from(a[n+1].children);t[o]&&t[o].focus()}break;case"ArrowUp":if(t.preventDefault(),n>0){const t=Array.from(a[n-1].children);t[o]&&t[o].focus()}break;case"Enter":case"F2":this.opts.editableRows&&(t.preventDefault(),this._startCellEdit(e))}})}_startCellEdit(t){const e=t.closest("tr"),s=Number(e.dataset.rowid),i=t.dataset.columnKey,a=this.rowById.get(s);if(!a||!i)return;const o=this.columns.find(t=>t.key===i);if(!o||"button"===o.type||"image"===o.type)return;this.state.editingCell={rowId:s,columnKey:i};const n=a[i]||"",r=document.createElement("input");r.type="number"===o.type?"number":"text",r.value=n,r.className="vg-edit-input",t.innerHTML="",t.appendChild(r),r.focus(),r.select();const l=(t=!1)=>{const e=t?r.value:n;if(t&&e!==n){const t=a[i];a[i]="number"===o.type?Number(e):e,this.opts.onRowEdit&&this.opts.onRowEdit(a,i,e,t)}this.state.editingCell=null,this._renderBody()};r.addEventListener("blur",()=>l(!0)),r.addEventListener("keydown",t=>{"Enter"===t.key?(t.preventDefault(),l(!0)):"Escape"===t.key&&(t.preventDefault(),l(!1))})}_bindContextMenu(){this.opts.contextMenu&&this.tableEl.addEventListener("contextmenu",t=>{const e=t.target.closest("tr[data-rowid]");if(!e)return;t.preventDefault();const s=Number(e.dataset.rowid),i=this.rowById.get(s);this._showContextMenu(t.clientX,t.clientY,i)})}_showContextMenu(t,e,s){const i=document.querySelector(".vg-context-menu");i&&i.remove();const a=document.createElement("div");a.className="vg-context-menu",a.style.position="fixed",a.style.left=t+"px",a.style.top=e+"px",a.style.zIndex="10000";[{label:"Copy Row",action:()=>this._copyRowToClipboard(s)},{label:"Edit Row",action:()=>console.log("Edit:",s)},{label:"Delete Row",action:()=>this._deleteRow(s)}].forEach(t=>{const e=document.createElement("div");e.className="vg-context-menu-item",e.textContent=t.label,e.onclick=()=>{t.action(),a.remove()},a.appendChild(e)}),document.body.appendChild(a);const o=t=>{a.contains(t.target)||(a.remove(),document.removeEventListener("click",o))};setTimeout(()=>document.addEventListener("click",o),0)}_copyRowToClipboard(t){const e=this.columns.map(e=>t[e.key]||"").join("\t");navigator.clipboard?.writeText(e).catch(()=>{const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)})}_deleteRow(t){const e=this.data.findIndex(e=>e===t);e>-1&&(this.data.splice(e,1),this._renderBody(),this._renderPager())}_renderBody(){const t=this._process();if(this.tbodyEl.innerHTML="",this.opts.tree.enabled){const e=t.pageFlatRows||[];if(0===e.length){const t=document.createElement("tr"),e=document.createElement("td");return e.colSpan=this._colCount(),e.className="vg-empty",e.textContent=this.opts.emptyMessage,t.appendChild(e),void this.tbodyEl.appendChild(t)}e.forEach(t=>{this.tbodyEl.appendChild(this._renderRow(t.row,t.depth,t))})}else if(t.hasGroups){const e=t.pageGroups;if(0===e.length){const t=document.createElement("tr"),e=document.createElement("td");return e.colSpan=this._colCount(),e.className="vg-empty",e.textContent=this.opts.emptyMessage,t.appendChild(e),void this.tbodyEl.appendChild(t)}e.forEach(t=>{const e=document.createElement("tr");e.className="vg-group";const s=document.createElement("td");s.colSpan=this._colCount();const i=this.state.collapsed.has(t.value);s.innerHTML=`\n            <button class="vg-group-header ${i?"is-collapsed":""}" data-group-value="${this._escAttr(t.value)}" title="${this._escAttr(this.opts.i18n.aria.toggleGroup)}" aria-expanded="${i?"false":"true"}">\n              <span class="vg-caret" aria-hidden="true"></span>\n              <span class="vg-group-title">${this._esc(this._headerLabelForGroup(t))}</span>\n            </button>\n            ${this._renderAggSummary(t)}\n          `,e.appendChild(s),this.tbodyEl.appendChild(e),t.rows.forEach(e=>{const s=this._renderRow(e);s.dataset.group=t.value,i&&(s.style.display="none"),this.tbodyEl.appendChild(s)})})}else{const e=t.pageRows;if(0===e.length){const t=document.createElement("tr"),e=document.createElement("td");return e.colSpan=this._colCount(),e.className="vg-empty",e.textContent=this.opts.emptyMessage,t.appendChild(e),void this.tbodyEl.appendChild(t)}e.forEach(t=>{this.tbodyEl.appendChild(this._renderRow(t))})}this._updateHeaderSelectionToggle(),this._applyColumnVisibility()}_parseMarkdownTables(t){const e=t.split(/\r?\n/),s=[];let i=0;const a=t=>/^\s*\|?\s*:?-{3,}:?\s*(\|\s*:?-{3,}:?\s*)+\|?\s*$/.test(t),o=t=>{const e=[];let s="",i=!1;t=t.replace(/^\s*\|?\s*/,"").replace(/\s*\|?\s*$/,"");for(let a of t)i?(s+=a,i=!1):"\\"!==a?"|"!==a?s+=a:(e.push(s.trim()),s=""):i=!0;return e.push(s.trim()),e};for(;i<e.length;){for(;i<e.length&&!/\|/.test(e[i]);)i++;if(i>=e.length)break;const t=e[i++];if(i>=e.length)break;if(!a(e[i]))continue;i++;const n=o(t),r=[];for(;i<e.length&&/\|/.test(e[i])&&!/^\s*$/.test(e[i]);){const t=o(e[i]);t.length>=1&&r.push(t),i++}const l=n.length,d=r.map(t=>{const e=t.slice(0,l);for(;e.length<l;)e.push("");return e});s.push({headers:n,rows:d})}return s}_mdInlineToHtml(t){let e=String(t??"");return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e=e.replace(/!\[([^\]]*)\]\(([^\)\s]+)(?:\s+"([^"]+)")?\)/g,(t,e,s)=>`<img src="${this._escAttr(s)}" alt="${this._escAttr(e)}" loading="lazy" class="vg-img" />`),e=e.replace(/\[([^\]]+)\]\(([^\)\s]+)(?:\s+"([^"]+)")?\)/g,(t,e,s)=>`<a href="${this._escAttr(s)}" target="_blank" rel="noopener noreferrer" class="vg-link">${e}</a>`),e=e.replace(/\*\*([^*]+)\*\*/g,"<b>$1</b>").replace(/\*([^*]+)\*/g,"<i>$1</i>").replace(/`([^`]+)`/g,"<code>$1</code>"),e}_slugify(t){return String(t).toLowerCase().trim().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")||"col"}_uniqueKeys(t){const e=[],s=new Map;return t.forEach(t=>{let i=t||"col",a=s.get(i)||0,o=i;a>0&&(o=`${i}_${a}`),s.set(i,a+1),e.push(o)}),e}_exportMatrix(){const t=this.columns.filter(t=>!this.state.hiddenCols.has(t.key)),e=t.map(t=>String(t.label??t.key)),s=this.opts.exporting&&this.opts.exporting.scope||"page";if(this.opts.tree.enabled){const i=this._filterSortTreeFlatten();return{headers:e,rows:("page"===s?i.slice((this.state.page-1)*this.state.pageSize,(this.state.page-1)*this.state.pageSize+this.state.pageSize):i).map(e=>t.map(t=>this._cellText(e.row,t)))}}const{rows:i,groups:a,hasGroups:o}=this._filterSortGroup();if(o){const i="page"===s?a.slice((this.state.page-1)*this.state.pageSize,(this.state.page-1)*this.state.pageSize+this.state.pageSize):a,o=[];return i.forEach(e=>{e.rows.forEach(e=>o.push(t.map(t=>this._cellText(e,t))))}),{headers:e,rows:o}}return{headers:e,rows:("page"===s?i.slice((this.state.page-1)*this.state.pageSize,(this.state.page-1)*this.state.pageSize+this.state.pageSize):i).map(e=>t.map(t=>this._cellText(e,t)))}}_toCSV(t){const e=t=>{const e=String(t??"");return/[",\n]/.test(e)?'"'+e.replace(/"/g,'""')+'"':e};return t.map(t=>t.map(e).join(",")).join("\n")}_toMarkdown(t,e){const s=t=>"| "+t.map(t=>String(t??"").replace(/\n/g," ")).join(" | ")+" |",i="| "+t.map(()=>"---").join(" | ")+" |";return[s(t),i,...e.map(s)].join("\n")}_downloadBlob(t,e,s){const i=new Blob([t],{type:s}),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.download=e,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(a)},0)}_renderRow(t,e=0,s=null){const i=document.createElement("tr");if(i.className="vg-tr",i.dataset.rowid=t.__vgid,this.opts.selectable){const e=document.createElement("td");e.className="vg-td vg-td-select";const s=document.createElement("input");s.type="checkbox",s.className="vg-select-row",s.checked=this.state.selected.has(t.__vgid),s.onchange=()=>{s.checked?this.state.selected.add(t.__vgid):this.state.selected.delete(t.__vgid),this._updateHeaderSelectionToggle(),this._emitSelection()},e.appendChild(s),i.appendChild(e)}return this.columns.forEach((e,a)=>{const o=document.createElement("td");if(o.className="vg-td",o.dataset.key=e.key,o.dataset.columnKey=e.key,o.tabIndex=this.opts.keyboardNavigation?0:-1,this.opts.tree.enabled&&0===a){o.classList.add("vg-tree-cell");const e=this._renderTreeToggle(t,s);e&&o.appendChild(e)}this._renderCell(o,t,e),i.appendChild(o)}),i}_renderCell(t,e,s){if("function"==typeof s.render){t.innerHTML="";const i=s.render(e[s.key],e,s);return void(i instanceof Node?t.appendChild(i):t.innerHTML=i??"")}const i=(s.type||"text").toLowerCase(),a=e[s.key],o=!!t.querySelector&&!!t.querySelector(".vg-tree-toggle");switch(i){case"number":{const i=this._toNumber(a),n="function"==typeof s.format?s.format(i,e):i??"";if(o){const e=document.createElement("span");e.textContent=n,t.appendChild(e)}else t.textContent=n;t.classList.add("vg-num");break}case"html":if(o){const e=document.createElement("span");e.innerHTML=a??"",t.appendChild(e)}else t.innerHTML=a??"";break;case"image":{const e=document.createElement("img");e.src=String(a||""),e.alt=s.image&&s.image.alt||"",s.image&&s.image.width&&(e.width=s.image.width),s.image&&s.image.height&&(e.height=s.image.height),e.loading="lazy",e.className="vg-img",t.appendChild(e);break}case"link":{const e=document.createElement("a"),i=String(a||""),o=s.link&&s.link.text||i;e.href=i,e.target=s.link&&s.link.target||"_blank",e.rel="noopener noreferrer",e.textContent=o,e.className="vg-link",t.appendChild(e);break}case"button":{const i=document.createElement("button");i.className="vg-btn",i.dataset.rowid=e.__vgid,i.dataset.colkey=s.key,i.type="button",i.textContent=s.button&&s.button.text||"Action",t.appendChild(i);break}case"progress":{const e=Math.max(0,Math.min(100,Number(a)||0)),s=document.createElement("div");s.className="vg-progress";const i=document.createElement("div");i.className="vg-progress-bar",i.style.width=e+"%";const o=document.createElement("span");o.className="vg-progress-text",o.textContent=e+"%",s.appendChild(i),s.appendChild(o),t.appendChild(s);break}case"rating":{const e=Math.max(0,Math.min(5,Number(a)||0)),s=document.createElement("span");s.className="vg-rating",s.title=e+"/5",s.textContent="★".repeat(Math.floor(e))+"☆".repeat(5-Math.floor(e)),t.appendChild(s);break}case"badge":{const i=e[s.key+"_class"]||"default",o=document.createElement("span");o.className=`vg-badge vg-badge-${i}`,o.textContent=a||"",t.appendChild(o);break}case"color":{const e=document.createElement("div");e.className="vg-color-indicator",e.style.backgroundColor=a||"",e.title=a||"",t.appendChild(e);break}default:if(this.opts.customCellTypes[i]){const n=this.opts.customCellTypes[i](a,s,e);if(o){const e=document.createElement("span");e.innerHTML=n,t.appendChild(e)}else t.innerHTML=n}else{const i="function"==typeof s.format?s.format(a,e):a??"";if(o){const e=document.createElement("span");e.textContent=i,t.appendChild(e)}else t.textContent=i}}}_renderTreeToggle(t,e){const s=this.opts.tree;if(!s.enabled)return null;const i=!(e&&null!=e.hasChildren?e.hasChildren:this._rowHasChildren(t)||this._rowPotentialChildren(t)),a=document.createElement("button");a.type="button",a.className="vg-tree-toggle",a.dataset.rowid=t.__vgid;const o=e?.depth||0;if(a.style.marginLeft=(Number(s.indent)||16)*o+"px",i)return a.classList.add("is-leaf"),a.innerHTML='<span class="vg-tree-spacer"></span>',a.disabled=!0,a;const n=this.state.loadingChildren.has(t.__vgid),r=this.state.expanded.has(t.__vgid);return a.classList.toggle("is-expanded",r),a.classList.toggle("is-loading",n),a.setAttribute("aria-label",r?this.opts.i18n.aria.collapseRow:this.opts.i18n.aria.expandRow),a.setAttribute("aria-expanded",r?"true":"false"),a.innerHTML=n?'<span class="vg-spinner"></span>':'<span class="vg-caret" aria-hidden="true"></span>',a}_renderAggSummary(t){const e=t.rows.length,s=[`<span class="vg-chip">${this._esc(this.opts.i18n.group.count)}: ${e}</span>`];return this.columns.filter(t=>Array.isArray(t.aggregations)&&t.aggregations.length).forEach(e=>{const i=t.aggregates[e.key]||{},a=e.aggregations,o=[];a.includes("sum")&&null!=i.sum&&o.push(`Σ ${this._fmtAgg(e,i.sum)}`),a.includes("min")&&null!=i.min&&o.push(`min ${this._fmtAgg(e,i.min)}`),a.includes("max")&&null!=i.max&&o.push(`max ${this._fmtAgg(e,i.max)}`),o.length&&s.push(`<span class="vg-chip">${this._esc(e.label??e.key)}: ${this._esc(o.join(" · "))}</span>`)}),s.length?`<div class="vg-agg">${s.join("")}</div>`:""}_fmtAgg(t,e){if("function"==typeof t.format)try{return t.format(e)}catch{return String(e)}return"number"==typeof e?e:String(e)}_headerLabelForGroup(t){const e=this.columns.find(t=>t.key===this.state.groupBy);return`${e?e.label??e.key:this.state.groupBy}: ${t.value}`}_renderPager(){if(!this.opts.pagination)return void(this.pagerEl.innerHTML="");const t=this.opts.serverPagination,{hasGroups:e,totalPages:s,totalCount:i}=t?this._processMetaRemote():this._processMeta(),a=Math.min(this.state.page,s||1),o=a<=1?"disabled":"",n=a>=s?"disabled":"",r=o,l=n,d=this.opts.pageSizes.map(t=>`<option value="${t}" ${+this.state.pageSize===+t?"selected":""}>${t}${this._esc(this.opts.i18n.perPageSuffix)}</option>`).join(""),c=this._columnsMenuConfig(),h=c&&"pager"===c.location?this._columnsMenuMarkup(c):"";this.pagerEl.innerHTML=`\n        <div class="vg-pager-row">\n          <div class="vg-pager-left">\n            <button class="vg-page-btn" data-action="first" ${r} aria-label="${this._escAttr(this.opts.i18n.pager.first)}" title="${this._escAttr(this.opts.i18n.pager.first)}">«</button>\n            <button class="vg-page-btn" data-action="prev" ${o} aria-label="${this._escAttr(this.opts.i18n.pager.prev)}" title="${this._escAttr(this.opts.i18n.pager.prev)}">‹</button>\n          </div>\n          <div class="vg-pager-center" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">\n            <span class="vg-page-info" aria-live="polite">${this._esc(this.opts.i18n.pager.pageInfo(a,s||1))}</span>\n            <span class="vg-total">${this._esc(e?this.opts.i18n.pager.totalGroups(i):this.opts.i18n.pager.totalRows(i))}</span>\n            <div class="vg-pagesize">\n              <select class="vg-size-select" aria-label="Page size">${d}</select>\n            </div>\n            ${h}\n          </div>\n          <div class="vg-pager-right">\n            <button class="vg-page-btn" data-action="next" ${n} aria-label="${this._escAttr(this.opts.i18n.pager.next)}" title="${this._escAttr(this.opts.i18n.pager.next)}">›</button>\n            <button class="vg-page-btn" data-action="last" ${l} aria-label="${this._escAttr(this.opts.i18n.pager.last)}" title="${this._escAttr(this.opts.i18n.pager.last)}">»</button>\n          </div>\n        </div>\n      `,this.state.page=a,this.pagerEl.querySelector('[data-action="first"]').onclick=()=>{1!==this.state.page&&(this.state.page=1,t?this._remoteLoad(this.state.page):(this._renderBody(),this._renderPager()))},this.pagerEl.querySelector('[data-action="prev"]').onclick=()=>{this.state.page>1&&(this.state.page--,t?this._remoteLoad(this.state.page):(this._renderBody(),this._renderPager()))},this.pagerEl.querySelector('[data-action="next"]').onclick=()=>{this.state.page<s&&(this.state.page++,t?this._remoteLoad(this.state.page):(this._renderBody(),this._renderPager()))},this.pagerEl.querySelector('[data-action="last"]').onclick=()=>{this.state.page!==s&&(this.state.page=s,t?this._remoteLoad(this.state.page):(this._renderBody(),this._renderPager()))};const p=this.pagerEl.querySelector(".vg-size-select");p&&(p.onchange=()=>this.setPageSize(+p.value)),this._bindColumnsMenuEvents(this.pagerEl)}_processMeta(){if(this.opts.tree.enabled){const t=this._filterSortTreeFlatten().length;return{hasGroups:!1,totalPages:Math.max(1,Math.ceil(t/this.state.pageSize)),totalCount:t}}const{rows:t,groups:e,hasGroups:s}=this._filterSortGroup();if(!this.opts.pagination)return{hasGroups:s,totalPages:1,totalCount:s?e.length:t.length};const i=s?e.length:t.length;return{hasGroups:s,totalPages:Math.max(1,Math.ceil(i/this.state.pageSize)),totalCount:i}}_process(){if(this.opts.tree.enabled){const t=this._filterSortTreeFlatten();if(!this.opts.pagination)return{hasGroups:!1,pageFlatRows:t};const{page:e,pageSize:s}=this.state,i=(e-1)*s;return{hasGroups:!1,pageFlatRows:t.slice(i,i+s)}}const{rows:t,groups:e,hasGroups:s}=this._filterSortGroup();if(!this.opts.pagination)return s?{hasGroups:s,pageGroups:e}:{hasGroups:s,pageRows:t};const{page:i,pageSize:a}=this.state;if(s){const t=(i-1)*a;return{hasGroups:s,pageGroups:e.slice(t,t+a)}}{const e=(i-1)*a;return{hasGroups:s,pageRows:t.slice(e,e+a)}}}_filterSortTreeFlatten(){const t=this.opts.tree.childrenKey,e=this.data.slice(),{sortKey:s,sortDir:i}=this.state,a=s?this.columns.find(t=>t.key===s):null,o=(a?.type||"text").toLowerCase(),n=this.opts.sortable&&a&&!this.opts.serverSorting,r=(t,e)=>this._compare(t,e,o,a||{}),l=e=>{if(Array.isArray(e)){if(n){const t="desc"===i?-1:1;e.sort((e,i)=>t*r(e[s],i[s]))}e.forEach(e=>l(e[t]))}};l(e);const d=String(this.state.filter||"");let c=null;if(d)if(this.state.regexMode)try{c={type:"regex",rx:new RegExp(d,"i")},this.state.regexError=""}catch(t){this.state.regexError=String(t?.message||"Invalid RegExp")}else this.state.regexError="",c={type:"text",needle:d.toLowerCase()};this._updateFilterError();const h=t=>{if(!c)return!0;if("regex"===c.type)return this.columns.some(e=>c.rx.test(this._cellText(t,e)));const e=c.needle;return this.columns.some(s=>this._cellText(t,s).toLowerCase().includes(e))},p=new Set,g=(e,s)=>{const i=Array.isArray(e[t])?e[t]:[];let a=h(e);return i.forEach(t=>{g(t,s.concat(e))&&(a=!0)}),c&&!a||(p.add(e),s.forEach(t=>p.add(t))),a};e.forEach(t=>g(t,[]));const u=[],v=(e,s)=>{Array.isArray(e)&&e.forEach(e=>{if(!p.has(e))return;const i=e.__vgid,a=this._rowHasChildren(e)||this._rowPotentialChildren(e),o=this.state.expanded.has(i)||!!c||this.opts.tree.initiallyExpanded;u.push({row:e,depth:s,hasChildren:a,expanded:o}),o&&Array.isArray(e[t])&&v(e[t],s+1)})};return v(e,0),u}_assignIdsDeep(t){if(!Array.isArray(t))return;const e=this.opts.tree.childrenKey;t.forEach(t=>{null==t.__vgid&&(t.__vgid=this._idCounter++),Array.isArray(t[e])&&this._assignIdsDeep(t[e])})}_indexRowsDeep(t){if(!Array.isArray(t))return;const e=this.opts.tree.childrenKey;t.forEach(t=>{this.rowById.set(t.__vgid,t),Array.isArray(t[e])&&this._indexRowsDeep(t[e])})}_rowHasChildren(t){const e=this.opts.tree.childrenKey;return Array.isArray(t?.[e])&&t[e].length>0}_rowPotentialChildren(t){const e=this.opts.tree.hasChildrenKey;return!!t&&!!t[e]}_shouldRemoteFetch(t){return"function"==typeof this.opts.loadPage&&(!!this.opts.serverPagination||(!(!this.opts.serverSorting||"sort"!==t)||(!(!this.opts.serverFiltering||"filter"!==t)||("init"===t?this.opts.serverPagination||this.opts.serverSorting||this.opts.serverFiltering:"page"===t&&this.opts.serverPagination))))}_processMetaRemote(){const t=this.state.serverTotalRows??this.data.length;return{hasGroups:!1,totalPages:Math.max(1,Math.ceil(t/this.state.pageSize)),totalCount:t}}_remoteLoad(t){if("function"!=typeof this.opts.loadPage)return this._renderBody(),void this._renderPager();const e={page:t||this.state.page||1,pageSize:this.state.pageSize,sortKey:this.state.sortKey,sortDir:this.state.sortDir,filter:this.state.filter,regexMode:this.state.regexMode};Promise.resolve(this.opts.loadPage(e)).then(t=>{const s=Array.isArray(t?.rows)?t.rows:[],i=Number.isFinite(t?.total)?t.total:s.length;this._idCounter=0,this._assignIdsDeep(s),this.data=s,this.rowById=new Map,this._indexRowsDeep(this.data),this.state.serverTotalRows=i,this.state.page=e.page}).finally(()=>{this._renderBody(),this._renderPager()})}_filterSortGroup(){let t=this.data.slice();const e=String(this.state.filter||"");if(e){if("tree"===this.state.filterMode){this.state.regexError="";const s=e.match(/^(\w+):"(.+)"$/);if(s){const[,e,i]=s;t=t.filter(t=>String(t[e]||"")===i)}else{const s=this.state.caseSensitive?e:e.toLowerCase();t=t.filter(t=>this.columns.some(e=>(this.state.caseSensitive?this._cellText(t,e):this._cellText(t,e).toLowerCase()).includes(s)))}}else if(this.state.regexMode||"regex"===this.state.filterMode)try{const s=this.state.caseSensitive||"case-sensitive"===this.state.filterMode?"":"i",i=new RegExp(e,s);this.state.regexError="",t=t.filter(t=>this.columns.some(e=>i.test(this._cellText(t,e))))}catch(t){this.state.regexError=String(t?.message||"Invalid RegExp")}else{this.state.regexError="";const s=this.state.caseSensitive||"case-sensitive"===this.state.filterMode?e:e.toLowerCase();t=t.filter(t=>this.columns.some(e=>(this.state.caseSensitive||"case-sensitive"===this.state.filterMode?this._cellText(t,e):this._cellText(t,e).toLowerCase()).includes(s)))}this._updateFilterError()}const{sortKey:s,sortDir:i}=this.state;if(s){const e=this.columns.find(t=>t.key===s);if(e){const s="desc"===i?-1:1,a=(e.type||"text").toLowerCase(),o=(t,s)=>this._compare(t,s,a,e);t.sort((t,i)=>s*o(t[e.key],i[e.key]))}}const a=this.state.groupBy;if(!a)return{hasGroups:!1,rows:t};const o=new Map;t.forEach(t=>{const e=null==t[a]?"(null)":String(t[a]);o.has(e)||o.set(e,[]),o.get(e).push(t)});const n=[];for(const[t,e]of o.entries())n.push({value:t,rows:e,aggregates:this._computeAggregates(e)});return{hasGroups:!0,groups:n}}_computeAggregates(t){const e={};return this.columns.forEach(s=>{if(!Array.isArray(s.aggregations)||0===s.aggregations.length)return;const i=t.map(t=>this._toNumber(t[s.key])).filter(t=>"number"==typeof t&&!Number.isNaN(t));if(!i.length)return;const a={};s.aggregations.includes("sum")&&(a.sum=i.reduce((t,e)=>t+e,0)),s.aggregations.includes("min")&&(a.min=Math.min(...i)),s.aggregations.includes("max")&&(a.max=Math.max(...i)),e[s.key]=a}),e}_cellText(t,e){if("function"==typeof e.render)try{const s=e.render(t[e.key],t,e);return s instanceof Node?(s.textContent||"").trim():String(s??"")}catch{return""}const s=(e.type||"text").toLowerCase(),i=t[e.key];switch(s){case"number":return String(this._toNumber(i)??"");case"html":{const t=document.createElement("div");return t.innerHTML=String(i??""),(t.textContent||"").trim()}case"image":default:return String(i??"");case"link":{const t=String(i??"");return(e.link&&e.link.text||t)+" "+t}case"button":return e.button&&e.button.text||"Action"}}_compare(t,e,s,i){if("function"==typeof i.sort)try{return i.sort(t,e)}catch{}if(null==t&&null==e)return 0;if(null==t)return-1;if(null==e)return 1;switch(s){case"number":{const s=this._toNumber(t),i=this._toNumber(e);return s===i?0:s<i?-1:1}case"html":{const s=this._stripHtml(String(t)),i=this._stripHtml(String(e));return s.localeCompare(i,void 0,{sensitivity:"base",numeric:!0})}default:{const s=String(t),i=String(e);return s.localeCompare(i,void 0,{sensitivity:"base",numeric:!0})}}}_toNumber(t){if("number"==typeof t)return t;if("string"==typeof t){const e=t.replace(/[^\d.+-]/g,""),s=parseFloat(e);return Number.isNaN(s)?void 0:s}}_stripHtml(t){return t.replace(/<[^>]*>/g,"")}_esc(t){return String(t??"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]))}_escAttr(t){return this._esc(t).replace(/"/g,"&quot;")}_updateFilterError(){if(!this.opts.filterable||!this.toolbarEl)return;const t=this.toolbarEl.querySelector(".vg-filter");if(!t)return;const e=t.querySelector(".vg-error");if(this.state.regexMode&&!!this.state.regexError)if(e)e.title=this.state.regexError,e.textContent=this.opts.i18n.invalidRegex;else{const e=document.createElement("span");e.className="vg-error",e.title=this.state.regexError,e.textContent=this.opts.i18n.invalidRegex,t.appendChild(e)}else e&&e.remove()}_colCount(){return this.columns.length+(this.opts.selectable?1:0)}_currentPageRowIds(){const t=[];if(this.opts.tree.enabled){(this._process().pageFlatRows||[]).forEach(e=>t.push(e.row.__vgid))}else{const{hasGroups:e,pageRows:s,pageGroups:i}=this._process();e?(i||[]).forEach(e=>e.rows.forEach(e=>t.push(e.__vgid))):(s||[]).forEach(e=>t.push(e.__vgid))}return t}_updateHeaderSelectionToggle(){if(!this.opts.selectable)return;const t=this.theadEl.querySelector(".vg-select-all");if(!t)return;const e=this._currentPageRowIds(),s=e.filter(t=>this.state.selected.has(t));t.checked=e.length>0&&s.length===e.length,t.indeterminate=s.length>0&&s.length<e.length}_emitSelection(){if("function"==typeof this.opts.onSelectionChange){const t=Array.from(this.state.selected).map(t=>this.rowById.get(t)).filter(Boolean);try{this.opts.onSelectionChange(t)}catch{}}}_applyColumnVisibility(){const t=this.state.hiddenCols;this.theadEl.querySelectorAll(".vg-th").forEach(e=>{const s=e.dataset.key;s&&(e.style.display=t.has(s)?"none":"")}),this.tbodyEl.querySelectorAll(".vg-td").forEach(e=>{const s=e.dataset.key;s&&(e.style.display=t.has(s)?"none":"")})}_generatePivotTable(){const t=this.state.originalData||this.data,e=this.opts.pivotConfig;if(!e.rows.length&&!e.columns.length)return void this._generatePivotSummary(t,e);const s=this._groupByFields(t,e.rows),i=e.columns.length?this._getUniqueValues(t,e.columns):[null],a=[];Object.entries(s).forEach(([t,s])=>{const o={},n=t.split("|");e.rows.forEach((t,e)=>{o[t]=n[e]||""}),i.forEach(t=>{const i=t?s.filter(s=>this._getFieldPath(s,e.columns)===t):s;e.values.forEach(s=>{const a=e.aggregations[s]||"sum";o[t?`${s}_${t}`:s]=this._aggregate(i,s,a)})}),a.push(o)});const o=[];e.rows.forEach(t=>{o.push({key:t,label:this._getFieldLabel(t),type:"text",sortable:!0})}),i.forEach(t=>{e.values.forEach(e=>{const s=t?`${e}_${t}`:e,i=t?`${this._getFieldLabel(e)} (${t})`:this._getFieldLabel(e);o.push({key:s,label:i,type:"number",sortable:!0,format:this._getNumberFormatter(e)})})}),this.state.pivotData={rows:a,columns:o},this.data=a,this.columns=o}_generatePivotSummary(t,e){if(!e.values.length)return this.state.pivotData={rows:[],columns:[]},this.data=[],void(this.columns=[]);const s={};e.values.forEach(i=>{const a=e.aggregations[i]||"sum";s[i]=this._aggregate(t,i,a)});const i=e.values.map(t=>({key:t,label:`${this._getFieldLabel(t)} (${e.aggregations[t]||"sum"})`,type:"number",sortable:!1,format:this._getNumberFormatter(t)}));this.state.pivotData={rows:[s],columns:i},this.data=[s],this.columns=i}_groupByFields(t,e){const s={};return t.forEach(t=>{const i=e.map(e=>this._getFieldValue(t,e)).join("|");s[i]||(s[i]=[]),s[i].push(t)}),s}_getUniqueValues(t,e){const s=new Set;return t.forEach(t=>{const i=this._getFieldPath(t,e);null!=i&&s.add(i)}),Array.from(s).sort()}_getFieldPath(t,e){return e.map(e=>this._getFieldValue(t,e)).join("|")}_getFieldValue(t,e){return t[e]??""}_getFieldLabel(t){const e=this.state.originalColumns?.find(e=>e.key===t);return e?.label||t}_aggregate(t,e,s){const i=t.map(t=>Number(t[e])).filter(t=>!isNaN(t));if(!i.length)return 0;switch(s){case"sum":default:return i.reduce((t,e)=>t+e,0);case"avg":return i.reduce((t,e)=>t+e,0)/i.length;case"min":return Math.min(...i);case"max":return Math.max(...i);case"count":return t.length}}_getNumberFormatter(t){const e=this.state.originalColumns?.find(e=>e.key===t);return e?.format||(t=>"number"==typeof t?t.toLocaleString():t)}_renderPivotToolbar(){const t=this.root.querySelector(".vg-toolbar");if(!t)return;t.innerHTML="";const e=document.createElement("div");e.className="vg-pivot-controls",this.state.pivotControlsCollapsed&&e.classList.add("collapsed");const s=this.state.pivotControlsCollapsed?"▸ Show Controls":"▾ Hide Controls";e.innerHTML=`\n        <div class="vg-pivot-header">\n          <div class="vg-pivot-title">\n            <h3>📊 Pivot Table Builder</h3>\n            <p>Drag fields into the areas below to build your pivot table</p>\n          </div>\n          <div class="vg-pivot-header-actions">\n            <button class="vg-btn vg-pivot-toggle" aria-expanded="${!this.state.pivotControlsCollapsed}">${s}</button>\n            <button class="vg-btn vg-pivot-exit">✕ Exit Pivot Mode</button>\n          </div>\n        </div>\n        \n        <div class="vg-pivot-workspace">\n          <div class="vg-pivot-fields-panel">\n            <h4>Available Fields</h4>\n            <div class="vg-pivot-available-fields" id="pivot-available-fields"></div>\n          </div>\n          \n          <div class="vg-pivot-config-panel">\n            <div class="vg-pivot-drop-zones">\n              <div class="vg-pivot-zone vg-pivot-filters">\n                <div class="vg-pivot-zone-header">\n                  <span class="vg-pivot-zone-icon">🔍</span>\n                  <span class="vg-pivot-zone-title">Filters</span>\n                  <span class="vg-pivot-zone-hint">Filter your data</span>\n                </div>\n                <div class="vg-pivot-field-list" data-type="filters"></div>\n              </div>\n\n              <div class="vg-pivot-zone vg-pivot-columns">\n                <div class="vg-pivot-zone-header">\n                  <span class="vg-pivot-zone-icon">📊</span>\n                  <span class="vg-pivot-zone-title">Columns</span>\n                  <span class="vg-pivot-zone-hint">Drag column fields here</span>\n                </div>\n                <div class="vg-pivot-field-list" data-type="columns"></div>\n              </div>\n              \n              <div class="vg-pivot-zone vg-pivot-rows">\n                <div class="vg-pivot-zone-header">\n                  <span class="vg-pivot-zone-icon">📋</span>\n                  <span class="vg-pivot-zone-title">Rows</span>\n                  <span class="vg-pivot-zone-hint">Drag row fields here</span>\n                </div>\n                <div class="vg-pivot-field-list" data-type="rows"></div>\n              </div>\n              \n              <div class="vg-pivot-zone vg-pivot-values">\n                <div class="vg-pivot-zone-header">\n                  <span class="vg-pivot-zone-icon">🔢</span>\n                  <span class="vg-pivot-zone-title">Values</span>\n                  <span class="vg-pivot-zone-hint">Drag numeric fields here</span>\n                </div>\n                <div class="vg-pivot-field-list" data-type="values"></div>\n              </div>\n            </div>\n            \n            <div class="vg-pivot-actions">\n              <button class="vg-btn vg-pivot-refresh">🔄 Refresh Pivot</button>\n              <button class="vg-btn vg-pivot-clear">🗑️ Clear All</button>\n              <button class="vg-btn vg-pivot-export">📊 Export Data</button>\n            </div>\n          </div>\n        </div>\n      `,t.appendChild(e),this._renderAvailableFields(),this._updatePivotFieldLists(),this._bindPivotEvents(),this._initializePivotDragDrop()}_renderAvailableFields(){const t=this.root.querySelector("#pivot-available-fields");if(!t)return;t.innerHTML="";this.getAvailableFields().forEach(e=>{const s=document.createElement("div");s.className="vg-pivot-field-chip",s.draggable=!0,s.dataset.field=e;const i=this._getFieldType(e),a="number"===i?"🔢":"date"===i?"📅":"📝";s.innerHTML=`\n          <span class="vg-field-icon">${a}</span>\n          <span class="vg-field-label">${this._getFieldLabel(e)}</span>\n          <span class="vg-field-type">${i}</span>\n        `,t.appendChild(s)})}_getFieldType(t){const e=this.state.originalData||this.data;if(!e.length)return"text";const s=e[0][t];return"number"==typeof s?"number":s instanceof Date||/^\d{4}-\d{2}-\d{2}/.test(s)?"date":"text"}_initializePivotDragDrop(){const t=this.root.querySelector("#pivot-available-fields"),e=this.root.querySelectorAll(".vg-pivot-field-list");t.addEventListener("dragstart",t=>{t.target.classList.contains("vg-pivot-field-chip")&&(t.dataTransfer.setData("text/plain",t.target.dataset.field),t.target.classList.add("vg-dragging"))}),t.addEventListener("dragend",t=>{t.target.classList.remove("vg-dragging")}),e.forEach(t=>{t.addEventListener("dragover",e=>{e.preventDefault(),t.classList.add("vg-drop-active")}),t.addEventListener("dragleave",e=>{t.contains(e.relatedTarget)||t.classList.remove("vg-drop-active")}),t.addEventListener("drop",e=>{e.preventDefault(),t.classList.remove("vg-drop-active");const s=e.dataTransfer.getData("text/plain"),i=e.dataTransfer.getData("source-type"),a=t.dataset.type;if(s&&a){if(this.opts.pivotConfig||(this.opts.pivotConfig={rows:[],columns:[],values:[],filters:[],aggregations:{}}),this.opts.pivotConfig[a]||(this.opts.pivotConfig[a]=[]),i&&i!==a&&this.opts.pivotConfig[i]){const t=this.opts.pivotConfig[i].indexOf(s);t>-1&&(this.opts.pivotConfig[i].splice(t,1),"values"===i&&delete this.opts.pivotConfig.aggregations[s])}this.opts.pivotConfig[a].includes(s)||(this.opts.pivotConfig[a].push(s),"values"!==a||this.opts.pivotConfig.aggregations[s]||(this.opts.pivotConfig.aggregations[s]="sum"),this._updatePivotFieldLists(),this.updatePivotConfig(this.opts.pivotConfig))}})}),this._makeFieldItemsDraggable()}_makeFieldItemsDraggable(){this.root.querySelectorAll(".vg-pivot-field-item").forEach(t=>{t.draggable=!0,t.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",t.dataset.field),e.dataTransfer.setData("source-type",t.closest(".vg-pivot-field-list").dataset.type),t.classList.add("vg-dragging")}),t.addEventListener("dragend",e=>{t.classList.remove("vg-dragging")})})}_updatePivotFieldLists(){this.root.querySelectorAll(".vg-pivot-field-list").forEach(t=>{const e=t.dataset.type,s=this.opts.pivotConfig[e]||[];if(t.innerHTML="",s.forEach((i,a)=>{const o=document.createElement("div");o.className="vg-pivot-field-item",o.dataset.field=i,o.draggable=!0;const n=this._getFieldType(i),r="number"===n?"🔢":"date"===n?"📅":"📝";if("values"===e){const t=this.opts.pivotConfig.aggregations[i]||"sum";o.innerHTML=`\n              <div class="vg-field-item-content">\n                <span class="vg-field-icon">${r}</span>\n                <span class="vg-field-label">${this._getFieldLabel(i)}</span>\n                <select class="vg-aggregation-select" data-field="${i}">\n                  <option value="sum" ${"sum"===t?"selected":""}>Sum</option>\n                  <option value="count" ${"count"===t?"selected":""}>Count</option>\n                  <option value="avg" ${"avg"===t?"selected":""}>Average</option>\n                  <option value="min" ${"min"===t?"selected":""}>Min</option>\n                  <option value="max" ${"max"===t?"selected":""}>Max</option>\n                </select>\n              </div>\n              <div class="vg-field-actions">\n                <button class="vg-field-move-up" data-field="${i}" data-type="${e}" ${0===a?"disabled":""}>↑</button>\n                <button class="vg-field-move-down" data-field="${i}" data-type="${e}" ${a===s.length-1?"disabled":""}>↓</button>\n                <button class="vg-field-remove" data-field="${i}" data-type="${e}">✕</button>\n              </div>\n            `}else o.innerHTML=`\n              <div class="vg-field-item-content">\n                <span class="vg-field-icon">${r}</span>\n                <span class="vg-field-label">${this._getFieldLabel(i)}</span>\n                ${"filters"===e?`\n                  <select class="vg-filter-operator" data-field="${i}">\n                    <option value="equals">Equals</option>\n                    <option value="contains">Contains</option>\n                    <option value="starts">Starts with</option>\n                    <option value="greater">Greater than</option>\n                    <option value="less">Less than</option>\n                  </select>\n                  <input type="text" class="vg-filter-value" data-field="${i}" placeholder="Filter value...">\n                `:""}\n              </div>\n              <div class="vg-field-actions">\n                <button class="vg-field-move-up" data-field="${i}" data-type="${e}" ${0===a?"disabled":""}>↑</button>\n                <button class="vg-field-move-down" data-field="${i}" data-type="${e}" ${a===s.length-1?"disabled":""}>↓</button>\n                <button class="vg-field-remove" data-field="${i}" data-type="${e}">✕</button>\n              </div>\n            `;t.appendChild(o)}),0===s.length){const e=document.createElement("div");e.className="vg-pivot-empty-state",e.innerHTML='\n            <div class="vg-empty-icon">📥</div>\n            <div class="vg-empty-text">Drag fields here</div>\n          ',t.appendChild(e)}}),this._makeFieldItemsDraggable()}_bindPivotEvents(){const t=this.root.querySelector(".vg-toolbar");if(!t)return;let e;t.querySelector(".vg-pivot-exit")?.addEventListener("click",()=>{this.disablePivot()}),t.querySelector(".vg-pivot-toggle")?.addEventListener("click",e=>{const s=e.currentTarget,i=t.querySelector(".vg-pivot-controls");this.state.pivotControlsCollapsed=!this.state.pivotControlsCollapsed,i&&i.classList.toggle("collapsed",this.state.pivotControlsCollapsed),s&&(s.textContent=this.state.pivotControlsCollapsed?"▸ Show Controls":"▾ Hide Controls",s.setAttribute("aria-expanded",String(!this.state.pivotControlsCollapsed)))}),t.querySelector(".vg-pivot-refresh")?.addEventListener("click",()=>{this.updatePivotConfig(this.opts.pivotConfig)}),t.querySelector(".vg-pivot-clear")?.addEventListener("click",()=>{this.clearPivotConfig()}),t.querySelector(".vg-pivot-export")?.addEventListener("click",()=>{this.exportPivotData()}),t.addEventListener("click",t=>{if(t.target.classList.contains("vg-field-remove")){const e=t.target.dataset.field,s=t.target.dataset.type;this.removePivotField(s,e)}else if(t.target.classList.contains("vg-field-move-up")){const e=t.target.dataset.field,s=t.target.dataset.type;this.movePivotField(s,e,-1)}else if(t.target.classList.contains("vg-field-move-down")){const e=t.target.dataset.field,s=t.target.dataset.type;this.movePivotField(s,e,1)}}),t.addEventListener("change",t=>{if(t.target.classList.contains("vg-aggregation-select")){const e=t.target.dataset.field;this.opts.pivotConfig.aggregations[e]=t.target.value,this.updatePivotConfig(this.opts.pivotConfig)}else(t.target.classList.contains("vg-filter-operator")||t.target.classList.contains("vg-filter-value"))&&this.applyPivotFilters()}),t.addEventListener("input",t=>{t.target.classList.contains("vg-filter-value")&&(clearTimeout(e),e=setTimeout(()=>{this.applyPivotFilters()},300))})}removePivotField(t,e){const s=this.opts.pivotConfig[t].indexOf(e);s>-1&&(this.opts.pivotConfig[t].splice(s,1),"values"===t&&delete this.opts.pivotConfig.aggregations[e],this._updatePivotFieldLists(),this.updatePivotConfig(this.opts.pivotConfig))}movePivotField(t,e,s){const i=this.opts.pivotConfig[t],a=i.indexOf(e);if(-1===a)return;const o=a+s;o<0||o>=i.length||([i[a],i[o]]=[i[o],i[a]],this._updatePivotFieldLists(),this.updatePivotConfig(this.opts.pivotConfig))}clearPivotConfig(){this.opts.pivotConfig={rows:[],columns:[],values:[],filters:[],aggregations:{}},this._updatePivotFieldLists(),this.updatePivotConfig(this.opts.pivotConfig)}applyPivotFilters(){const t={};this.root.querySelectorAll(".vg-filter-value").forEach(e=>{const s=e.dataset.field,i=e.value.trim(),a=this.root.querySelector(`.vg-filter-operator[data-field="${s}"]`)?.value||"equals";i&&(t[s]={operator:a,value:i})}),this.opts.pivotConfig.filters=t,this.updatePivotConfig(this.opts.pivotConfig)}exportPivotData(){const t=(this.opts.pivotMode,this.data);if(!t||!t.length)return console.warn("No data available for export"),void alert("No data available for export. Please configure your pivot table first.");console.log("Exporting pivot data:",t.length,"rows");const e=this.convertToCSV(t);if(!e)return console.warn("CSV conversion failed"),void alert("Failed to convert data to CSV format.");this.downloadCSV(e,"pivot-table.csv")}convertToCSV(t){if(!t||!t.length)return console.warn("ConvertToCSV: No data provided"),"";console.log("Converting to CSV:",t.length,"rows");const e=t[0];if(!e||"object"!=typeof e)return console.warn("ConvertToCSV: Invalid data format"),"";const s=Object.keys(e),i=[s.join(",")];return t.forEach((t,e)=>{const a=s.map(e=>{const s=t[e];return null==s?"":"string"==typeof s?`"${s.replace(/"/g,'""')}"`:s});i.push(a.join(","))}),console.log("CSV generated:",i.length,"lines"),i.join("\n")}downloadCSV(t,e){const s=new Blob([t],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");if(void 0!==i.download){const t=URL.createObjectURL(s);i.setAttribute("href",t),i.setAttribute("download",e),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i)}}getSelectedRows(){return Array.from(this.state.selected).map(t=>this.rowById.get(t)).filter(Boolean)}clearSelection(){this.state.selected.clear(),this._updateHeaderSelectionToggle(),this._renderBody(),this._emitSelection()}}"undefined"!=typeof module&&void 0!==module.exports?module.exports=e:t.VanillaGrid=e}("undefined"!=typeof window?window:globalThis);